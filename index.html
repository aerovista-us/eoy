<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EchoStory ‚Äî Comprehensive Year Capsule (AeroVista/EchoVerse/NXCore)</title>
  <meta name="theme-color" content="#0b0f14" />
  <meta name="description" content="AeroVista/EchoVerse/NXCore Year Capsule with comprehensive narrative, music player, and capsule system" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.webmanifest" />
  
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="48x48" href="./icons/icon-48x48.png" />
  <link rel="icon" type="image/png" sizes="72x72" href="./icons/icon-72x72.png" />
  <link rel="icon" type="image/png" sizes="96x96" href="./icons/icon-96x96.png" />
  <link rel="icon" type="image/png" sizes="128x128" href="./icons/icon-128x128.png" />
  <link rel="icon" type="image/png" sizes="144x144" href="./icons/icon-144x144.png" />
  <link rel="icon" type="image/png" sizes="152x152" href="./icons/icon-152x152.png" />
  <link rel="icon" type="image/png" sizes="167x167" href="./icons/icon-167x167.png" />
  <link rel="icon" type="image/png" sizes="180x180" href="./icons/icon-180x180.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png" />
  <link rel="icon" type="image/png" sizes="256x256" href="./icons/icon-256x256.png" />
  <link rel="icon" type="image/png" sizes="384x384" href="./icons/icon-384x384.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512x512.png" />
  
  <!-- Apple Touch Icon -->
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="./icons/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="./icons/icon-152x152.png" />
  <link rel="apple-touch-icon" sizes="167x167" href="./icons/icon-167x167.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-180x180.png" />
  
  <!-- PWA Meta Tags -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="EchoStory" />
  <style>
    :root{
      --bg:#0b0f14; --txt:#e7f0ff; --muted:#9fb3cc;
      --a:#7c5cff; --b:#27e0ff; --g:#2cff8f; --y:#ffd34d; --r:#ff4d6d;
      --br:18px; --shadow: 0 20px 60px rgba(0,0,0,.45);
      --stroke: rgba(255,255,255,.08);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--txt);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(124,92,255,.22), transparent 60%),
        radial-gradient(900px 700px at 90% 10%, rgba(39,224,255,.14), transparent 55%),
        radial-gradient(800px 650px at 30% 90%, rgba(44,255,143,.10), transparent 60%),
        linear-gradient(180deg, #070a0f, var(--bg));
      background-image:
        url('./images/wallpaper_portrait.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-blend-mode: overlay;
      min-height:100vh; overflow-x:hidden;
      position: relative;
      /* Performance optimization */
      will-change: auto;
      contain: layout style paint;
    }
    body::before{
      content: "";
      position: fixed;
      inset: 0;
      background: 
        radial-gradient(1200px 800px at 20% -10%, rgba(124,92,255,.22), transparent 60%),
        radial-gradient(900px 700px at 90% 10%, rgba(39,224,255,.14), transparent 55%),
        radial-gradient(800px 650px at 30% 90%, rgba(44,255,143,.10), transparent 60%),
        linear-gradient(180deg, rgba(7,10,15,.85), rgba(11,15,20,.95));
      pointer-events: none;
      z-index: 0;
    }
    body > * { position: relative; z-index: 1; }
    @media (orientation: landscape) and (min-width: 1024px){
      body{ background-image: url('./images/wallpaper_landscape.png'); }
    }
    @media (max-width: 768px){
      body{ background-image: url('./images/wallpaper_mobile.png'); }
    }
    .wrap{max-width:1220px; margin:0 auto; padding:28px 16px 64px;}
    .top{display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; gap:12px; align-items:center;}
    .sig{
      width:44px; height:44px; border-radius:14px;
      object-fit:cover;
      box-shadow: 0 10px 40px rgba(124,92,255,.22);
      border:1px solid rgba(255,255,255,.08);
    }
    h1{margin:0; font-size:20px; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px; margin-top:2px}
    .pillbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{
      padding:9px 12px; border-radius:999px; background:rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      color:var(--muted); font-size:12px; display:flex; gap:8px; align-items:center;
      backdrop-filter: blur(10px);
      max-width:min(720px, 100%);
    }
    .pill strong{color:var(--txt); font-weight:650}
    .pill .clip{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:inline-block; max-width:560px}
    .grid{display:grid; grid-template-columns: 1.35fr .65fr; gap:16px; margin-top:16px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius:var(--br);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 12px;
      background:linear-gradient(180deg, rgba(0,0,0,.25), transparent);
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .title{font-size:14px; font-weight:750; margin:0}
    .hint{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35}
    .bd{padding:14px 16px 16px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      appearance:none; border:none; cursor:pointer;
      padding:10px 12px; border-radius:12px;
      background:rgba(124,92,255,.15);
      color:var(--txt); font-weight:700; font-size:13px;
      border:1px solid rgba(124,92,255,.35);
      transition: transform .12s ease, background .12s ease, border-color .12s ease, box-shadow .15s ease;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(124,92,255,.2); border-color:rgba(124,92,255,.55)}
    .btn:active{transform:scale(0.98) translateY(0);}
    .btn:focus-visible{
      outline:2px solid rgba(39,224,255,.8);
      outline-offset:2px;
      box-shadow: 0 0 0 4px rgba(39,224,255,.2);
    }
    .btn.secondary{background:rgba(39,224,255,.10); border-color:rgba(39,224,255,.35)}
    .btn.ghost{background:rgba(255,255,255,.05); border-color:rgba(255,255,255,.12); color:var(--muted); font-weight:650}
    .btn.danger{background:rgba(255,77,109,.12); border-color:rgba(255,77,109,.35)}
    .sep{height:1px; background:rgba(255,255,255,.08); margin:12px 0}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      padding:9px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04); color:var(--muted); font-weight:650; font-size:12px;
      cursor:pointer; user-select:none;
    }
    .tab[aria-selected="true"]{
      color:var(--txt);
      border-color:rgba(39,224,255,.42);
      background:rgba(39,224,255,.10);
    }
    .scene{
      display:none;
      opacity:0;
      transform:translateY(8px);
      transition: opacity .25s ease, transform .25s ease;
    }
    .scene.active{
      display:block;
      opacity:1;
      transform:none;
      animation: fadeInSlide .25s ease both;
    }
    @keyframes fadeInSlide{
      from{opacity:0; transform:translateY(8px)}
      to{opacity:1; transform:none}
    }
    @keyframes fadeIn{from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none}}

    .quote{
      padding:14px 14px;
      border-radius:14px;
      background:linear-gradient(180deg, rgba(12,18,26,.75), rgba(12,18,26,.35));
      border:1px solid rgba(255,255,255,.10);
      line-height:1.55;
      position:relative;
      overflow:hidden;
    }
    .quote:before{
      content:""; position:absolute; inset:-80px;
      background:
        radial-gradient(360px 180px at 15% 30%, rgba(39,224,255,.18), transparent 60%),
        radial-gradient(340px 160px at 80% 70%, rgba(124,92,255,.16), transparent 62%);
      opacity:.9;
    }
    .quote > *{position:relative}
    .mono{font-family:var(--mono); font-size:12px; color:rgba(231,240,255,.78)}
    .kicker{
      font-size:12px; color:rgba(231,240,255,.85);
      display:flex; gap:8px; align-items:center;
      margin-bottom:8px;
    }
    .dot{width:8px; height:8px; border-radius:99px; background:rgba(44,255,143,.9); box-shadow: 0 0 0 6px rgba(44,255,143,.12)}
    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .chip{
      font-size:11px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:rgba(231,240,255,.75);
    }
    .twoCol{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 900px){ .twoCol{grid-template-columns:1fr} }

    .checklist{display:grid; gap:8px}
    .checklist-item{
      opacity:0;
      transform:translateX(-4px);
      animation: fadeInSlideLeft .25s ease forwards;
    }
    .checklist-item:nth-child(1){animation-delay:0.05s}
    .checklist-item:nth-child(2){animation-delay:0.1s}
    .checklist-item:nth-child(3){animation-delay:0.15s}
    .checklist-item:nth-child(4){animation-delay:0.2s}
    .checklist-item:nth-child(5){animation-delay:0.25s}
    .checklist-item:nth-child(n+6){animation-delay:0.3s}
    @keyframes fadeInSlideLeft{
      from{opacity:0; transform:translateX(-4px)}
      to{opacity:1; transform:none}
    }
    .item{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 10px; border-radius:14px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
    }
    .item input{margin-top:3px; transform:scale(1.1)}
    .item .lbl{font-size:13px; line-height:1.35}
    .small{font-size:12px; color:var(--muted)}
    .meter{
      height:10px; border-radius:999px; background:rgba(255,255,255,.08);
      overflow:hidden; border:1px solid rgba(255,255,255,.10);
    }
    .meter > div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(39,224,255,.9), rgba(124,92,255,.9), rgba(44,255,143,.9));
      transition: width .25s ease;
    }
    textarea, input[type="text"], select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      color:var(--txt);
      outline:none;
      font-size:13px;
    }
    textarea{min-height:120px; resize:vertical}
    .footer{
      margin-top:16px; color:var(--muted); font-size:12px; line-height:1.45;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .badge{
      font-family:var(--mono);
      font-size:11px;
      color:rgba(231,240,255,.75);
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      padding:6px 10px;
      border-radius:999px;
    }
    .glowline{
      height:1px; background:linear-gradient(90deg, transparent, rgba(39,224,255,.25), rgba(124,92,255,.25), rgba(44,255,143,.18), transparent);
      margin:16px 0;
    }

    /* subtle particles */
    .bgfx{pointer-events:none; position:fixed; inset:0; opacity:.55; mix-blend-mode:screen;}
    .bgfx span{position:absolute; width:2px; height:2px; border-radius:999px; background:rgba(39,224,255,.9); animation: drift linear infinite; opacity:.65;}
    @keyframes drift{
      from{transform:translate3d(0,0,0); opacity:.0}
      15%{opacity:.7}
      85%{opacity:.7}
      to{transform:translate3d(0,-120vh,0); opacity:0}
    }

    /* MUSIC PLAYER STYLES */
    :root{
      --ev-bg:#0b0f14;
      --ev-txt:#e7f0ff;
      --ev-muted:#9fb3cc;
      --ev-stroke:rgba(255,255,255,.10);
      --ev-a:#7c5cff;
      --ev-b:#27e0ff;
      --ev-g:#2cff8f;
      --ev-y:#ffd34d;
      --ev-r:#ff4d6d;
      --ev-br:18px;
      --ev-shadow:0 20px 60px rgba(0,0,0,.45);
      --ev-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --ev-sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .ev-wrap{max-width:1200px; margin:0 auto; padding:18px 16px 34px; color:var(--ev-txt); font-family:var(--ev-sans);}
    .ev-hero{display:flex; gap:14px; align-items:center; margin-bottom:14px; flex-wrap:wrap;}
    .ev-sigil{
      width:52px; height:52px; border-radius:16px;
      object-fit:cover;
      box-shadow: 0 10px 40px rgba(124,92,255,.22);
      flex:0 0 auto;
      border:1px solid var(--ev-stroke);
    }
    .ev-album-cover{
      position:relative; flex:0 0 auto;
      width:120px; height:120px; border-radius:16px;
      overflow:hidden; box-shadow: 0 10px 40px rgba(0,0,0,.45);
      border:1px solid var(--ev-stroke);
    }
    .ev-cover-img{
      width:100%; height:100%; object-fit:cover;
      transition: transform .3s ease;
    }
    .ev-album-cover:hover .ev-cover-img{transform:scale(1.05);}
    .ev-tag-overlay{
      position:absolute; bottom:6px; right:6px;
      width:32px; height:auto; opacity:.9;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.5));
    }
    @media (max-width: 640px){
      .ev-album-cover{width:80px; height:80px;}
      .ev-tag-overlay{width:24px; bottom:4px; right:4px;}
    }
    .ev-title{margin:0; font-size:18px; letter-spacing:.2px}
    .ev-title span{color:rgba(39,224,255,.95)}
    .ev-sub{margin:4px 0 0; color:var(--ev-muted); font-size:13px; line-height:1.35}
    .ev-badges{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .ev-badge{
      font-size:11px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.05);
      border:1px solid var(--ev-stroke); color:rgba(231,240,255,.8);
    }

    .ev-grid{display:grid; grid-template-columns: 1.25fr .75fr; gap:14px;}
    @media (max-width: 980px){ .ev-grid{grid-template-columns:1fr} }

    .ev-card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--ev-stroke);
      border-radius:var(--ev-br);
      box-shadow:var(--ev-shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .ev-cardHead{
      padding:14px 14px 12px;
      background:linear-gradient(180deg, rgba(0,0,0,.25), transparent);
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .ev-cardTitle{font-size:14px; font-weight:750}
    .ev-cardHint{font-size:12px; color:var(--ev-muted); margin-top:4px; line-height:1.3}
    .ev-mini{display:flex; gap:8px; flex-wrap:wrap}

    .ev-btn{
      appearance:none; border:none; cursor:pointer;
      padding:10px 12px; border-radius:12px;
      background:rgba(124,92,255,.15);
      color:var(--ev-txt); font-weight:750; font-size:13px;
      border:1px solid rgba(124,92,255,.35);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .ev-btn:hover{transform:translateY(-1px); background:rgba(124,92,255,.20); border-color:rgba(124,92,255,.55)}
    .ev-btn:active{transform:scale(0.98) translateY(0);}
    .ev-btn.primary{background:rgba(39,224,255,.14); border-color:rgba(39,224,255,.40)}
    .ev-btn.ghost{background:rgba(255,255,255,.05); border-color:rgba(255,255,255,.14); color:rgba(231,240,255,.78); font-weight:650}
    .ev-btn:focus-visible{
      outline:2px solid rgba(39,224,255,.8);
      outline-offset:2px;
      box-shadow: 0 0 0 4px rgba(39,224,255,.2);
    }
    .ev-btn-icon{
      display:flex; align-items:center; justify-content:center; gap:6px;
      padding:10px;
    }
    .ev-icon{
      width:20px; height:20px; object-fit:contain;
      filter: brightness(0.9);
      transition: transform .15s ease, filter .15s ease;
    }
    .ev-btn:hover .ev-icon{filter: brightness(1.1);}
    .ev-btn:active .ev-icon{transform:scale(0.95);}
    .ev-loop-text{margin-left:4px; font-size:13px;}

    .ev-now{padding:12px 14px 14px}
    .ev-nowLine1{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .ev-letter{
      font-family:var(--ev-mono);
      font-size:12px; padding:4px 8px; border-radius:999px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14);
    }
    .ev-trackName{font-size:16px; font-weight:850; letter-spacing:.2px}
    .ev-nowLine2{display:flex; gap:8px; align-items:center; color:var(--ev-muted); font-size:12px; margin-top:5px}
    .ev-dot{opacity:.7}

    .ev-progress{margin-top:12px}
    .ev-progress input[type="range"]{
      width:100%;
      transition: opacity .2s ease;
    }
    .ev-progress input[type="range"]:hover{opacity:1}
    .ev-progressMeta{display:flex; justify-content:space-between; margin-top:6px}
    .ev-small{font-size:12px; color:var(--ev-muted)}
    .ev-controls{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-top:12px;
    }
    .ev-controls > div, .ev-right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .ev-vol{display:flex; gap:8px; align-items:center}
    .ev-vol input[type="range"]{
      width:140px;
      transition: opacity .2s ease;
    }
    .ev-vol input[type="range"]:hover{opacity:1}
    @media (max-width: 560px){ .ev-vol input[type="range"]{width:120px} }
    .ev-version{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .ev-vbtn[aria-pressed="true"]{
      border-color: rgba(39,224,255,.55) !important;
      background: rgba(39,224,255,.10) !important;
      color: rgba(231,240,255,.92) !important;
    }
    .ev-vbtn[disabled]{
      opacity:.45; cursor:not-allowed;
    }

    .ev-notes{
      margin-top:12px;
      padding:12px 12px;
      border-radius:14px;
      background:linear-gradient(180deg, rgba(12,18,26,.70), rgba(12,18,26,.35));
      border:1px solid rgba(255,255,255,.10);
    }
    .ev-notesHead{font-size:12px; color:rgba(231,240,255,.82); font-weight:800; letter-spacing:.2px; margin-bottom:6px}
    .ev-notesBody{font-size:13px; line-height:1.45; color:rgba(231,240,255,.90)}
    .ev-notesTags{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .ev-tag{
      font-size:11px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:rgba(231,240,255,.76);
    }

    .ev-lyrics-panel{
      margin-top:12px;
      padding:12px 12px;
      border-radius:14px;
      background:linear-gradient(180deg, rgba(12,18,26,.70), rgba(12,18,26,.35));
      border:1px solid rgba(255,255,255,.10);
    }
    .ev-lyrics-content{
      font-size:13px; line-height:1.45; color:rgba(231,240,255,.90);
      white-space:pre-line;
    }

    .ev-divider{height:1px; background:linear-gradient(90deg, transparent, rgba(39,224,255,.25), rgba(124,92,255,.25), rgba(44,255,143,.18), transparent);}
    .ev-list-header{
      padding:12px 14px 8px; display:flex; align-items:center; gap:8px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .ev-list-icon{width:18px; height:18px; opacity:.7;}
    .ev-list-title{font-size:12px; font-weight:800; color:var(--ev-muted); text-transform:uppercase; letter-spacing:.5px;}
    .ev-list{padding:10px 10px 12px; display:grid; gap:8px}
    .ev-row{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 10px;
      border-radius:14px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .ev-row:hover{transform:translateY(-1px); border-color:rgba(39,224,255,.25); background:rgba(255,255,255,.06)}
    .ev-row.active{border-color:rgba(39,224,255,.45); background:rgba(39,224,255,.08)}
    .ev-rowLeft{display:flex; gap:10px; align-items:center; min-width:0}
    .ev-rowTitle{font-weight:800; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .ev-rowMeta{font-size:11px; color:var(--ev-muted); margin-top:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:60ch}
    .ev-rowRight{display:flex; gap:10px; align-items:center; color:var(--ev-muted); font-size:12px}
    .ev-chip{
      font-family:var(--ev-mono); font-size:11px; padding:4px 8px; border-radius:999px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:rgba(231,240,255,.72);
    }

    .ev-foot{padding:10px 14px 14px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; border-top:1px solid rgba(255,255,255,.06)}

    .ev-bookletBody{padding:12px 14px 16px; color:rgba(231,240,255,.90)}
    .ev-bookletBody h3{margin:12px 0 6px; font-size:13px; letter-spacing:.2px}
    .ev-bookletBody p, .ev-bookletBody li{font-size:13px; line-height:1.5; color:rgba(231,240,255,.85)}
    .ev-bookletBody ul{margin:6px 0 0 18px}
    .ev-quote{
      border-radius:14px; padding:12px 12px;
      background:linear-gradient(180deg, rgba(12,18,26,.75), rgba(12,18,26,.35));
      border:1px solid rgba(255,255,255,.10);
      margin:10px 0 12px;
    }
    .ev-quoteKicker{font-size:11px; color:rgba(231,240,255,.75); letter-spacing:.25px; text-transform:uppercase}
    .ev-quoteText{font-size:14px; font-weight:850; margin-top:6px}
    .ev-bookletTrack{
      padding:10px 10px; border-radius:14px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      margin-top:8px;
      cursor:pointer;
    }
    .ev-bookletTrack:hover{border-color:rgba(39,224,255,.25)}
    .ev-bookletTrack b{display:block; font-size:13px}
    .ev-bookletTrack p{margin:6px 0 0; color:rgba(231,240,255,.80)}

    /* Shortcuts Modal */
    .modal-overlay{
      position:fixed; inset:0; z-index:10000;
      background:rgba(0,0,0,.75);
      backdrop-filter: blur(8px);
      display:flex; align-items:center; justify-content:center;
      padding:20px;
      animation: fadeIn .2s ease;
    }
    .modal-content{
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius:var(--br);
      box-shadow:var(--shadow);
      max-width:520px; width:100%;
      max-height:85vh; overflow-y:auto;
      animation: slideUp .25s ease;
    }
    .modal-header{
      padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between;
      background:linear-gradient(180deg, rgba(0,0,0,.2), transparent);
    }
    .modal-header h3{margin:0; font-size:16px; font-weight:800}
    .modal-close{
      appearance:none; border:none; background:none;
      color:var(--muted); font-size:24px; line-height:1;
      cursor:pointer; padding:4px 8px;
      border-radius:8px; transition: all .12s ease;
    }
    .modal-close:hover{background:rgba(255,255,255,.08); color:var(--txt)}
    .modal-close:focus-visible{
      outline:2px solid rgba(39,224,255,.8);
      outline-offset:2px;
    }
    .modal-body{padding:18px}
    .shortcuts-section{margin-bottom:20px}
    .shortcuts-section:last-child{margin-bottom:0}
    .shortcuts-section h4{
      margin:0 0 12px; font-size:13px; font-weight:800;
      color:rgba(39,224,255,.9); text-transform:uppercase; letter-spacing:.5px;
    }
    .shortcut-item{
      display:flex; align-items:center; gap:12px;
      padding:10px 0; border-bottom:1px solid rgba(255,255,255,.06);
    }
    .shortcut-item:last-child{border-bottom:none}
    .shortcut-item kbd{
      font-family:var(--mono); font-size:12px;
      padding:6px 10px; border-radius:8px;
      background:rgba(0,0,0,.3); border:1px solid rgba(255,255,255,.15);
      color:var(--txt); font-weight:700; min-width:32px; text-align:center;
      box-shadow: 0 2px 4px rgba(0,0,0,.2);
    }
    .shortcut-item span{
      font-size:13px; color:var(--txt); flex:1;
    }
    @keyframes slideUp{
      from{opacity:0; transform:translateY(20px)}
      to{opacity:1; transform:none}
    }
    @media (max-width: 640px){
      .modal-content{max-width:calc(100vw - 24px); margin:12px}
      .modal-body{padding:14px}
    }

    /* Print-friendly for music player */
    @media print{
      body{background:#fff !important; color:#000 !important}
      .bgfx, .pillbar, .tabs, .btn, .asideOnly{display:none !important}
      .card{box-shadow:none !important}
      .quote{background:#fff !important; border:1px solid #ddd !important}
      .mono,.small{color:#333 !important}
      .ev-btn, #ev-btn-copy, #ev-btn-booklet, #ev-saveBadge, #ev-lastSaved, #ev-lyrics-panel {display:none !important;}
      .ev-card{box-shadow:none !important;}
      .modal-overlay{display:none !important;}
    }
  </style>
</head>

<body>
  <div class="bgfx" id="bgfx" aria-hidden="true"></div>

  <!-- Shortcuts Overlay Modal -->
  <div class="modal-overlay" id="shortcutsModal" role="dialog" aria-labelledby="shortcutsTitle" aria-modal="true" style="display:none">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="shortcutsTitle">Keyboard Shortcuts</h3>
        <button class="modal-close" id="shortcutsClose" aria-label="Close shortcuts">√ó</button>
      </div>
      <div class="modal-body">
        <div class="shortcuts-section">
          <h4>Player Controls</h4>
          <div class="shortcut-item">
            <kbd>Space</kbd>
            <span>Play/Pause</span>
          </div>
          <div class="shortcut-item">
            <kbd>N</kbd>
            <span>Next track</span>
          </div>
          <div class="shortcut-item">
            <kbd>P</kbd>
            <span>Previous track</span>
          </div>
          <div class="shortcut-item">
            <kbd>L</kbd>
            <span>Toggle loop</span>
          </div>
          <div class="shortcut-item">
            <kbd>Y</kbd>
            <span>Toggle lyrics</span>
          </div>
          <div class="shortcut-item">
            <kbd>V</kbd>
            <span>Toggle take (v1 / v2)</span>
          </div>
          <div class="shortcut-item">
            <kbd>S</kbd>
            <span>Toggle mode (Sample / Full)</span>
          </div>
          <div class="shortcut-item">
            <kbd>‚Üê</kbd> / <kbd>‚Üí</kbd>
            <span>Seek backward/forward 5s</span>
          </div>
        </div>
        <div class="shortcuts-section">
          <h4>Navigation</h4>
          <div class="shortcut-item">
            <kbd>?</kbd>
            <span>Show this shortcuts overlay</span>
          </div>
          <div class="shortcut-item">
            <kbd>Esc</kbd>
            <span>Close modal/overlay</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="top">
      <div class="brand">
        <img src="./icons/icon-192x192.png" alt="EchoStory" class="sig" aria-hidden="true" />
        <div>
          <h1>EchoStory ‚Äî <span style="color:rgba(39,224,255,.95)">Comprehensive Year Capsule</span></h1>
          <div class="sub">AeroVista + NXCore + AeroCoreOS + EchoVerse + Ops discipline ‚Üí sealed into a living capsule.</div>
        </div>
      </div>
      <div class="pillbar">
        <div class="pill"><span>üß†</span><strong id="modeLabel">Story Mode</strong></div>
        <div class="pill"><span>üß≠</span><span>Mantra:</span><strong class="clip" id="mantraPill">I build environments where good outcomes become the default.</strong></div>
        <div class="pill"><span>üíæ</span><span>Autosave:</span><strong>On</strong></div>
        <div class="pill"><span>‚öôÔ∏è</span><span class="mono" id="capsuleId">EV-CAPSULE-2026</span></div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <section class="card" aria-label="EchoStory narrative">
        <div class="hd">
          <div>
            <p class="title">Scenes</p>
            <p class="hint">Most comprehensive EchoStory to date: year signals + quarters + guardrails + ecosystem ledger + standards + 2026 map + cadence + capsule exports.</p>
          </div>
          <div class="tabs" role="tablist" aria-label="Scene tabs">
            <button class="tab" role="tab" aria-selected="true" data-scene="scene0">Prologue</button>
            <button class="tab" role="tab" aria-selected="false" data-scene="sceneSignals">Year Signals</button>
            <button class="tab" role="tab" aria-selected="false" data-scene="sceneQuarters">Quarter Reel</button>
            <button class="tab" role="tab" aria-selected="false" data-scene="sceneGuardrails">Guardrails</button>
            <button class="tab" role="tab" aria-selected="false" data-scene="sceneEcosystem">Ecosystem</button>
            <button class="tab" role="tab" aria-selected="false" data-scene="sceneLedger">Milestone Ledger</button>
            <button class="tab" role="tab" aria-selected="false" data-scene="sceneStandards">Standards</button>
            <button class="tab" role="tab" aria-selected="false" data-scene="scenePhilo">Philosophy</button>
            <button class="tab" role="tab" aria-selected="false" data-scene="sceneMan">Manifesto</button>
            <button class="tab" role="tab" aria-selected="false" data-scene="sceneMap">2026 Map</button>
            <button class="tab" role="tab" aria-selected="false" data-scene="sceneCadence">Cadence</button>
            <button class="tab" role="tab" aria-selected="false" data-scene="sceneCapsule">Capsule</button>
          </div>
        </div>

        <div class="bd">
          <!-- Prologue -->
          <div class="scene active" id="scene0">
            <div class="quote">
              <div class="kicker"><span class="dot"></span><b>PROLOGUE</b> <span class="small">‚Äî from proving ‚Üí to inevitability</span></div>
              <p>
                The early phase looks like sparks: bright ideas, fast motion, hard to hold.
              </p>
              <p>
                Then something changes:
                you stop trying to prove you can build ‚Äî
                and start building like the outcome is inevitable.
              </p>
              <p>
                This year didn‚Äôt chase flares.
                This year forged a <b>spine</b>.
                Coherence became the win condition.
              </p>

              <div class="glowline"></div>

              <p class="mono"><b>Operator mantra:</b> <span id="mantraInline">I build environments where good outcomes become the default.</span></p>
              <p class="mono"><b>Daily filter:</b> reduce friction ‚Ä¢ deepen meaning ‚Ä¢ strengthen system</p>

              <div class="chips">
                <span class="chip">Integration over accumulation</span>
                <span class="chip">Meaning before polish</span>
                <span class="chip">Long arcs over loud moments</span>
                <span class="chip">Subtraction is creation</span>
                <span class="chip">Documentation is respect</span>
              </div>

              <div class="glowline"></div>
              <p class="mono">LOG: Integrity ‚Üë ‚Ä¢ Friction ‚Üì ‚Ä¢ Identity compressed ‚Ä¢ Convergence achieved</p>
            </div>

            <div class="sep"></div>
            <div class="row">
              <button class="btn" data-jump="sceneSignals">Continue ‚Üí</button>
              <button class="btn ghost" id="btnToggleAudio">Enable ambience</button>
              <span class="small" id="audioStatus">Ambience: Off</span>
            </div>
            <audio id="ambience" loop preload="none"></audio>
          </div>

          <!-- Signals -->
          <div class="scene" id="sceneSignals">
            <div class="quote">
              <div class="kicker"><span class="dot" style="background:rgba(255,211,77,.95); box-shadow:0 0 0 6px rgba(255,211,77,.14)"></span><b>YEAR IN SIGNALS</b></div>
              <p><b>You didn‚Äôt just build things ‚Äî you integrated.</b> The year is defined by connection: systems, story, output, and intention.</p>
              <p><b>You chose infrastructure over applause.</b> You invested in what lasts: structure, defaults, documentation, stability.</p>
              <p><b>Your creative voice sharpened.</b> Not louder ‚Äî clearer. Characters, sound, brand language gained boundaries.</p>
              <p><b>You closed loops.</b> Repair + hardening beat novelty chasing.</p>
              <p><b>You stayed aligned.</b> Meaning remained central under pressure.</p>
              <div class="glowline"></div>
              <p class="mono">Signal summary: coherence > volume ‚Ä¢ durability > hype ‚Ä¢ completion > novelty</p>
            </div>
            <div class="sep"></div>
            <div class="row">
              <button class="btn secondary" data-jump="sceneQuarters">Quarter Reel ‚Üí</button>
              <button class="btn ghost" data-jump="sceneCapsule">Seal to Capsule ‚Üí</button>
            </div>
          </div>

          <!-- Quarters -->
          <div class="scene" id="sceneQuarters">
            <div class="quote">
              <div class="kicker"><span class="dot" style="background:rgba(39,224,255,.95); box-shadow:0 0 0 6px rgba(39,224,255,.14)"></span><b>QUARTER REEL</b> <span class="small">‚Äî stabilize ‚Üí structure ‚Üí compress ‚Üí converge</span></div>
              <p><b>Q1 ‚Äî Clearing the Noise:</b> you stopped mistaking activity for progress. Roadmap authority returned.</p>
              <p><b>Q2 ‚Äî Structural Integrity:</b> builder energy evolved into architect behavior. Decisions became durable.</p>
              <p><b>Q3 ‚Äî Identity Compression:</b> subtraction became creation. Output and systems got intentional.</p>
              <p><b>Q4 ‚Äî System Convergence:</b> everything orbited one center. Tools supported story; story supported function.</p>
              <div class="glowline"></div>
              <p class="mono">Quarter thesis: stabilize ‚Üí structure ‚Üí compress ‚Üí converge.</p>
            </div>
            <div class="sep"></div>
            <div class="row">
              <button class="btn secondary" data-jump="sceneGuardrails">Guardrails ‚Üí</button>
              <button class="btn ghost" data-jump="sceneEcosystem">Ecosystem ‚Üí</button>
            </div>
          </div>

          <!-- Guardrails -->
          <div class="scene" id="sceneGuardrails">
            <div class="quote">
              <div class="kicker"><span class="dot" style="background:rgba(255,77,109,.95); box-shadow:0 0 0 6px rgba(255,77,109,.14)"></span><b>GUARDRAILS</b> <span class="small">‚Äî double down / drop</span></div>
              <div class="twoCol">
                <div>
                  <p><b>DOUBLE DOWN</b></p>
                  <ul>
                    <li><b>Integration-first thinking</b> ‚Äî connected systems win.</li>
                    <li><b>Narrative-backed systems</b> ‚Äî tools carry meaning; story has function.</li>
                    <li><b>Finishing energy</b> ‚Äî closing loops is leverage.</li>
                    <li><b>Internal coherence</b> ‚Äî if it makes sense inside, it scales outside.</li>
                  </ul>
                </div>
                <div>
                  <p><b>DROP / REDUCE</b></p>
                  <ul>
                    <li><b>Over-rescuing half-ideas</b> ‚Äî some projects already taught the lesson.</li>
                    <li><b>Explaining before shipping</b> ‚Äî presence > persuasion.</li>
                    <li><b>Over-polishing before meaning</b> ‚Äî clarity first; shine later.</li>
                    <li><b>Re-litigating decisions</b> ‚Äî choose, then move.</li>
                  </ul>
                </div>
              </div>
              <div class="glowline"></div>
              <p class="mono">Guardrail test: if it doesn‚Äôt reduce friction, deepen meaning, or strengthen the system ‚Äî it‚Äôs optional.</p>
            </div>
            <div class="sep"></div>
            <div class="row">
              <button class="btn secondary" data-jump="sceneEcosystem">Ecosystem ‚Üí</button>
              <button class="btn ghost" data-jump="sceneCapsule">Seal to Capsule ‚Üí</button>
            </div>
          </div>

          <!-- Ecosystem -->
          <div class="scene" id="sceneEcosystem">
            <div class="quote">
              <div class="kicker"><span class="dot" style="background:rgba(124,92,255,.95); box-shadow:0 0 0 6px rgba(124,92,255,.14)"></span><b>ECOSYSTEM</b> <span class="small">‚Äî what you‚Äôre actually building</span></div>
              <p><b>AeroVista</b> isn‚Äôt ‚Äúa project.‚Äù It‚Äôs an ecosystem that makes creative output repeatable and operationally real.</p>
              <p><b>NXCore</b> is the spine: services, storage, routing, reliability, local-first power.</p>
              <p><b>AeroCoreOS</b> is the cockpit: a unified command center that turns complexity into usable flows.</p>
              <p><b>EchoVerse</b> is the signal: music, story, and artifacts that carry the brand‚Äôs heartbeat.</p>
              <div class="glowline"></div>
              <p><b>Divisions (high-level intent):</b></p>
              <ul>
                <li><b>Nexus TechWorks</b> ‚Äî full-stack engineering, AI, infrastructure, security, automation.</li>
                <li><b>SkyForge Creative</b> ‚Äî interactive storytelling, game/AR/VR experiences.</li>
                <li><b>EchoVerse Audio</b> ‚Äî music production, catalogs, players, sonic identity.</li>
                <li><b>Summit Learning</b> ‚Äî education, mentoring, training modules.</li>
                <li><b>Lumina Creative</b> ‚Äî branding, marketing, design systems.</li>
                <li><b>Vespera Publishing</b> ‚Äî narrative frameworks, documentation, books/courses.</li>
                <li><b>Horizon Aerial & Visual</b> ‚Äî drone + mapping + visuals + 3D outputs.</li>
              </ul>
              <div class="glowline"></div>
              <p class="mono">Design law: story + infrastructure + repeatability. Not vibes. Not chaos. A system that holds.</p>
            </div>
            <div class="sep"></div>
            <div class="row">
              <button class="btn secondary" data-jump="sceneLedger">Milestone Ledger ‚Üí</button>
              <button class="btn ghost" data-jump="sceneStandards">Standards ‚Üí</button>
            </div>
          </div>

          <!-- Milestone Ledger -->
          <div class="scene" id="sceneLedger">
            <div class="quote">
              <div class="kicker"><span class="dot" style="background:rgba(44,255,143,.95); box-shadow:0 0 0 6px rgba(44,255,143,.14)"></span><b>MILESTONE LEDGER</b> <span class="small">‚Äî the ‚Äúreal work‚Äù wins</span></div>
              <ul>
                <li><b>NXCore</b> became the authoritative replacement: storage, services, shares, and local-first posture.</li>
                <li><b>EchoVerse</b> returned to a huge milestone: catalog playable again at scale (UI integration gaps next).</li>
                <li><b>AeroCoreOS direction</b> stabilized: cockpit-first UX, unified endpoints, realistic multi-month path.</li>
                <li><b>Documentation habit</b> hardened: session reports, blueprints, SOP instincts.</li>
                <li><b>Operational tooling</b> matured: dashboards, exports, catalog pipelines, repeatable workflows.</li>
                <li><b>Brand pipeline</b> matured: print-ready specs discipline + listing metadata mindset.</li>
                <li><b>Ops/Compliance clarity</b> stayed intact: escalation alignment + training thresholds + reporting rhythm.</li>
              </ul>
              <div class="glowline"></div>
              <p class="mono">Ledger principle: build what you can maintain. document what you can‚Äôt afford to forget.</p>
            </div>
            <div class="sep"></div>
            <div class="row">
              <button class="btn secondary" data-jump="sceneStandards">Standards ‚Üí</button>
              <button class="btn ghost" data-jump="scenePhilo">Philosophy ‚Üí</button>
            </div>
          </div>

          <!-- Standards -->
          <div class="scene" id="sceneStandards">
            <div class="quote">
              <div class="kicker"><span class="dot" style="background:rgba(255,211,77,.95); box-shadow:0 0 0 6px rgba(255,211,77,.14)"></span><b>STANDARDS</b> <span class="small">‚Äî your moral + operational spine</span></div>
              <p><b>Integrity is non-negotiable.</b> Systems should protect people, not confuse them.</p>
              <p><b>Policies must be consistent.</b> Escalations follow defined standards; training is measurable; clarity beats ambiguity.</p>
              <p><b>Documentation is respect.</b> If it matters, it must be written so someone else can follow it.</p>
              <p><b>Local-first is resilience.</b> Your ecosystem should keep working even when the internet, vendors, or hype cycles don‚Äôt.</p>
              <div class="glowline"></div>
              <p class="mono">Standard: durable systems + ethical posture + repeatable truth.</p>
            </div>
            <div class="sep"></div>
            <div class="row">
              <button class="btn secondary" data-jump="scenePhilo">Philosophy ‚Üí</button>
              <button class="btn ghost" data-jump="sceneMap">2026 Map ‚Üí</button>
            </div>
          </div>

          <!-- Philosophy -->
          <div class="scene" id="scenePhilo">
            <div class="quote">
              <div class="kicker"><span class="dot" style="background:rgba(39,224,255,.95); box-shadow:0 0 0 6px rgba(39,224,255,.14)"></span><b>PERSONAL OPERATING PHILOSOPHY</b></div>
              <p><b>Core premise:</b> I operate as a system steward, not a task executor. My job is to create environments where good outcomes become the default.</p>
              <p><b>1 ‚Äî Integration beats accumulation.</b> If it doesn‚Äôt connect, it doesn‚Äôt belong.</p>
              <p><b>2 ‚Äî Meaning precedes optimization.</b> I do not polish confusion.</p>
              <p><b>3 ‚Äî Infrastructure is an act of care.</b> Systems should respect future users ‚Äî including future me.</p>
              <p><b>4 ‚Äî Subtraction is creation.</b> Removing the wrong thing is as valuable as building the right one.</p>
              <p><b>5 ‚Äî Long arcs over loud moments.</b> Durability over applause.</p>
              <p><b>6 ‚Äî Trust decisions once made.</b> Re-litigating is disguised fear.</p>
              <div class="glowline"></div>
              <p class="mono"><b>Daily filter:</b> reduce friction ‚Ä¢ deepen meaning ‚Ä¢ strengthen system</p>
            </div>
            <div class="sep"></div>
            <div class="row">
              <button class="btn secondary" data-jump="sceneMan">Manifesto ‚Üí</button>
              <button class="btn ghost" data-jump="sceneCadence">Cadence ‚Üí</button>
            </div>
          </div>

          <!-- Manifesto -->
          <div class="scene" id="sceneMan">
            <div class="quote">
              <div class="kicker"><span class="dot" style="background:rgba(124,92,255,.95); box-shadow:0 0 0 6px rgba(124,92,255,.14)"></span><b>FOUNDER LETTER / MANIFESTO</b></div>
              <p>I didn‚Äôt start this to chase trends. I started it because systems were broken ‚Äî and people were expected to adapt instead of being supported.</p>
              <p>AeroVista exists to prove something simple: infrastructure and creativity are not opposites. They are partners.</p>
              <p>We build tools that carry story. We tell stories that function.</p>
              <p>We believe: good systems feel human ‚Ä¢ documentation is respect ‚Ä¢ silence can be intentional ‚Ä¢ durability is more impressive than speed.</p>
              <p>We don‚Äôt ship noise. We ship clarity. We don‚Äôt build for everyone. We build for those who notice.</p>
              <p>If you‚Äôre here, it‚Äôs because something resonated ‚Äî not because we explained it well enough. That‚Äôs intentional.</p>
              <div class="glowline"></div>
              <p class="mono">‚Äî Founder</p>
            </div>
            <div class="sep"></div>
            <div class="row">
              <button class="btn secondary" data-jump="sceneMap">Open 2026 Map ‚Üí</button>
              <button class="btn ghost" data-jump="sceneCapsule">Seal to Capsule ‚Üí</button>
            </div>
          </div>

          <!-- 2026 Map -->
          <div class="scene" id="sceneMap">
            <div class="quote">
              <div class="kicker"><span class="dot" style="background:rgba(44,255,143,.95); box-shadow:0 0 0 6px rgba(44,255,143,.14)"></span><b>2026 MAP</b> <span class="small">‚Äî P1 / P2 / P3 + focus lanes</span></div>

              <p class="small"><b>Focus lanes (pick one as primary each month):</b> Spine ‚Ä¢ Integration ‚Ä¢ Story ‚Ä¢ Commerce</p>

              <p><b>P1 ‚Äî Non-negotiables</b></p>
              <ul>
                <li><b>Spine:</b> NXCore stability/observability; harden storage/shares/services; backups + monitoring discipline.</li>
                <li><b>Cockpit:</b> AeroCoreOS UX polish; fewer surprises; clearer flows; ‚Äúone obvious way‚Äù per action.</li>
                <li><b>Signal:</b> EchoVerse UI integration for already-built backend capabilities; artwork/media reliability; queue/playlist management.</li>
                <li><b>Automation:</b> n8n self-hosted stack deployed + seeded workflows (webhooks/schedulers/backups).</li>
                <li><b>Docs:</b> Master index + rollups (Active Tasks / Decisions / Ideas), updated continuously.</li>
              </ul>

              <p><b>P2 ‚Äî Expansion with discipline</b></p>
              <ul>
                <li><b>Selective exposure:</b> controlled public presence, observe friction honestly.</li>
                <li><b>Reporting maturity:</b> CX Pulse-style dashboards, drilldowns, and automated reporting habits.</li>
                <li><b>Brand pipeline:</b> Print-ready exports, consistent listing metadata, storefront structure that doesn‚Äôt rot.</li>
                <li><b>Collaboration:</b> plug-in ready systems, low-risk collaborators, no rewrites for others yet.</li>
              </ul>

              <p><b>P3 ‚Äî Optional</b></p>
              <ul>
                <li><b>Monetization experiments</b> that don‚Äôt distort the system.</li>
                <li><b>New projects</b> only if they reuse existing infrastructure with no net-new maintenance burden.</li>
                <li><b>Delight layer</b> (animations/polish) after function is complete.</li>
              </ul>

              <div class="glowline"></div>
              <p><b>12-month arc (likely):</b></p>
              <ul>
                <li><b>Months 1‚Äì3:</b> refinement + friction removal (spine hardening).</li>
                <li><b>Months 4‚Äì6:</b> selective visibility (presence without chasing).</li>
                <li><b>Months 7‚Äì12:</b> orchestration (systems work without you present).</li>
              </ul>

              <div class="glowline"></div>
              <p class="mono">End state: other people can enter the ecosystem and understand it without you present.</p>
            </div>

            <div class="sep"></div>
            <div class="row">
              <button class="btn secondary" data-jump="sceneCadence">Cadence ‚Üí</button>
              <button class="btn ghost" id="btnExportJson">Export JSON</button>
              <button class="btn ghost" id="btnExportMd">Export Markdown</button>
              <button class="btn ghost" id="btnPrint">Print View</button>
            </div>
          </div>

          <!-- Cadence -->
          <div class="scene" id="sceneCadence">
            <div class="quote">
              <div class="kicker"><span class="dot" style="background:rgba(255,211,77,.95); box-shadow:0 0 0 6px rgba(255,211,77,.14)"></span><b>OPERATING CADENCE</b> <span class="small">‚Äî keep the system alive</span></div>

              <p><b>Daily (3 minutes):</b></p>
              <ul>
                <li><b>Filter:</b> reduce friction / deepen meaning / strengthen system</li>
                <li><b>Choose one:</b> one Spine action, one Integration improvement, one Story step, or one Cleanup cut</li>
                <li><b>Seal one sentence:</b> a note future-you can trust</li>
              </ul>

              <p><b>Weekly (30 minutes):</b></p>
              <ul>
                <li><b>Close one loop</b> (finish something open)</li>
                <li><b>Honor one guardrail</b> (delete/decline something optional)</li>
                <li><b>Improve one integration</b> (remove a handoff step)</li>
              </ul>

              <p><b>Monthly (60 minutes):</b></p>
              <ul>
                <li><b>Spine audit:</b> what‚Äôs fragile, loud, unclear</li>
                <li><b>Priorities reset:</b> confirm P1/P2/P3 still true</li>
                <li><b>Visibility choice:</b> what becomes public next (if anything)</li>
              </ul>

              <div class="glowline"></div>
              <p class="mono">Cadence rule: protect finishing energy. protect coherence. protect meaning.</p>
            </div>

            <div class="sep"></div>
            <div class="row">
              <button class="btn secondary" data-jump="sceneCapsule">Open Capsule ‚Üí</button>
              <button class="btn ghost" data-jump="sceneMap">Back to 2026 Map</button>
            </div>
          </div>

          <!-- Capsule -->
          <div class="scene" id="sceneCapsule">
            <p class="title" style="margin:0 0 8px">EchoStory Capsule (Master)</p>
            <p class="hint" style="margin:0 0 12px">
              This capsule is designed to become your ‚Äúrunning notes log‚Äù anchor: track progress, decisions, and wins‚Äîexportable for NXCore ingestion later.
            </p>

            <div class="meter" aria-label="Progress meter"><div id="bar"></div></div>
            <div class="small" style="margin-top:8px" id="progressText">0% complete</div>

            <div class="sep"></div>

            <div class="checklist" id="checklist"></div>

            <div class="sep"></div>

            <div class="twoCol">
              <div>
                <label class="small"><b>Visibility mode</b></label>
                <select id="visibilityMode">
                  <option value="private">Private (internal)</option>
                  <option value="selective">Selective (controlled exposure)</option>
                  <option value="public">Public (publish-ready)</option>
                </select>
              </div>
              <div>
                <label class="small"><b>Primary lane this month</b></label>
                <select id="focusLane">
                  <option value="spine">Spine</option>
                  <option value="integration">Integration</option>
                  <option value="story">Story</option>
                  <option value="commerce">Commerce</option>
                  <option value="cleanup">Cleanup</option>
                </select>
              </div>
            </div>

            <div class="sep"></div>

            <label class="small" for="notes"><b>Notes / decisions / wins</b></label>
            <textarea id="notes" placeholder="Decisions, blockers, wins, the one sentence Future-You needs."></textarea>

            <div class="row" style="margin-top:12px">
              <button class="btn secondary" id="btnSave">Save</button>
              <button class="btn ghost" id="btnCopyJson">Copy JSON</button>
              <button class="btn ghost" id="btnCopyMd">Copy Markdown</button>
              <button class="btn danger" id="btnReset">Reset</button>
            </div>

            <div class="footer">
              <span class="badge" id="saveStamp">Last saved: ‚Äî</span>
              <span class="badge mono">Storage: local only</span>
            </div>
          </div>

        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card asideOnly" aria-label="Operator console">
        <div class="hd">
          <div>
            <p class="title">Operator Console</p>
            <p class="hint">Quick jumps, mantra control, ambience loader, and exports.</p>
          </div>
          <span class="badge">EchoStory Master</span>
        </div>

        <div class="bd">
          <p class="small"><b>Quick jumps</b></p>
          <div class="row">
            <button class="btn ghost" data-jump="sceneSignals">Signals</button>
            <button class="btn ghost" data-jump="sceneEcosystem">Ecosystem</button>
            <button class="btn ghost" data-jump="sceneLedger">Ledger</button>
            <button class="btn ghost" data-jump="sceneMap">2026</button>
            <button class="btn ghost" data-jump="sceneCapsule">Capsule</button>
          </div>

          <div class="sep"></div>

          <p class="small"><b>Ambience (optional)</b></p>
          <input type="text" id="audioUrl" placeholder="Paste direct URL to mp3/wav..." />
          <div class="row" style="margin-top:10px">
            <button class="btn secondary" id="btnLoadAudio">Load</button>
            <button class="btn ghost" id="btnStopAudio">Stop</button>
          </div>

          <div class="sep"></div>

          <p class="small"><b>Mantra</b></p>
          <input type="text" id="mantraInput" placeholder="Edit mantra..." />
          <div class="row" style="margin-top:10px">
            <button class="btn secondary" id="btnSetMantra">Set</button>
            <button class="btn ghost" id="btnResetMantra">Reset</button>
          </div>

          <div class="sep"></div>

          <p class="small"><b>Exports</b></p>
          <div class="row">
            <button class="btn ghost" id="btnSideExportJson">Export JSON</button>
            <button class="btn ghost" id="btnSideExportMd">Export Markdown</button>
            <button class="btn ghost" id="btnSidePrint">Print</button>
          </div>

          <div class="row" style="margin-top:8px">
            <button class="btn secondary" id="ev-btn-install" style="display:none; width:100%">üì± Install App</button>
            <button class="btn ghost" id="ev-btn-offline">üíæ Cache Offline</button>
          </div>

          <div class="sep"></div>

          <div class="quote" style="padding:12px">
            <p style="margin:0 0 6px"><b>Decision filter</b></p>
            <p class="mono" style="margin:0">reduce friction ‚Ä¢ deepen meaning ‚Ä¢ strengthen system</p>
          </div>
        </div>
      </aside>
    </div>

    <!-- MUSIC PLAYER SECTION -->
    <section id="echostory-coherence" class="ev-wrap">
      <header class="ev-hero">
        <img src="./icons/icon-192x192.png" alt="EchoStory" class="ev-sigil" aria-hidden="true" />
        <div class="ev-album-cover">
          <img src="./images/album_cover.jpg" alt="COHERENCE BY DEFAULT" class="ev-cover-img" />
          <img src="./icons/echostory_tag.png" alt="EchoStory" class="ev-tag-overlay" />
        </div>
        <div class="ev-heroText">
          <h2 class="ev-title">EchoStory Album Booklet ‚Äî <span>"COHERENCE BY DEFAULT"</span></h2>
          <p class="ev-sub">
            Systems log turned into Swamp-Hop. Sparks ‚Üí Spine. Integration ‚Üí Durability ‚Üí Cadence.
          </p>
          <div class="ev-badges">
            <span class="ev-badge">Playlist Player</span>
            <span class="ev-badge">Booklet Mode</span>
            <span class="ev-badge" id="ev-saveBadge">Autosave: On</span>
            <span class="ev-badge ev-mono" id="ev-versionBadge">Mode: Sample ‚Ä¢ Take: v1</span>
          </div>
        </div>
      </header>

      <div class="ev-grid">
        <!-- PLAYER CARD -->
        <article class="ev-card ev-player" aria-label="EchoStory playlist player">
          <div class="ev-cardHead">
            <div>
            <div class="ev-cardTitle">Now Playing</div>
            <div class="ev-cardHint">Tap a track. Player remembers last track + position + chosen version.</div>
            </div>
            <div class="ev-mini">
              <button class="ev-btn ghost" id="ev-btn-booklet">Booklet</button>
              <button class="ev-btn ghost" id="ev-btn-copy">Copy Tracklist</button>
            </div>
          </div>

          <div class="ev-now">
            <div class="ev-nowMeta">
              <div class="ev-nowLine1">
                <span class="ev-letter" id="ev-letter">A</span>
                <span class="ev-trackName" id="ev-trackName">Inevitable Spine</span>
              </div>
              <div class="ev-nowLine2">
                <span class="ev-small" id="ev-trackFile">inevitable_spine.mp3</span>
                <span class="ev-dot">‚Ä¢</span>
                <span class="ev-small" id="ev-trackTime">0:00 / 0:00</span>
              </div>
            </div>

            <div class="ev-progress">
              <input id="ev-seek" type="range" min="0" max="1000" value="0" step="1" aria-label="Seek" />
              <div class="ev-progressMeta">
                <span class="ev-small" id="ev-cur">0:00</span>
                <span class="ev-small" id="ev-dur">0:00</span>
              </div>
            </div>

            <div class="ev-controls">
              <button class="ev-btn" id="ev-prev" aria-label="Previous">‚èÆ</button>
              <button class="ev-btn primary" id="ev-play" aria-label="Play/Pause">‚ñ∂</button>
              <button class="ev-btn" id="ev-next" aria-label="Next">‚è≠</button>

              <div class="ev-right">
                <button class="ev-btn ghost" id="ev-loop" aria-label="Loop">Loop: Off</button>
                <button class="ev-btn ghost" id="ev-lyrics" aria-label="Lyrics">Lyrics</button>
                <div class="ev-version">
                  <span class="ev-small">Mode</span>
                  <button class="ev-btn ghost ev-vbtn" id="ev-sHuman" aria-pressed="true">Sample</button>
                  <button class="ev-btn ghost ev-vbtn" id="ev-sAI" aria-pressed="false">Full</button>
                  <span class="ev-small" style="margin-left:6px">Take</span>
                  <button class="ev-btn ghost ev-vbtn" id="ev-vStd" aria-pressed="true">v1</button>
                  <button class="ev-btn ghost ev-vbtn" id="ev-vAlt" aria-pressed="false">v2</button>
                </div>
                <div class="ev-vol">
                  <span class="ev-small">Vol</span>
                  <input id="ev-vol" type="range" min="0" max="1" value="0.9" step="0.01" aria-label="Volume" />
                </div>
              </div>
            </div>

            <div class="ev-notes">
              <div class="ev-notesHead">Liner Notes</div>
              <div class="ev-notesBody" id="ev-notesBody">
                The moment the builder becomes the architect. No more flare-gun wins‚Äîjust durable outcomes.
              </div>
              <div class="ev-notesTags" id="ev-tags"></div>
            </div>

            <div class="ev-lyrics-panel" id="ev-lyrics-panel" style="display:none">
              <div class="ev-notesHead">Lyrics & Structure</div>
              <div class="ev-lyrics-content" id="ev-lyrics-content"></div>
            </div>
          </div>

          <div class="ev-divider"></div>
          <div class="ev-list-header">
            <img src="./icons/list.png" alt="Playlist" class="ev-list-icon" />
            <span class="ev-list-title">Playlist</span>
          </div>
          <div class="ev-list" id="ev-list" aria-label="Playlist"></div>

          <audio id="ev-audio" preload="metadata"></audio>

          <div class="ev-foot">
            <div class="ev-small">
              Shortcuts: <b>Space</b>=Play/Pause ‚Ä¢ <b>‚Üê/‚Üí</b>=Seek 5s ‚Ä¢ <b>N/P</b>=Next/Prev ‚Ä¢ <b>L</b>=Loop ‚Ä¢ <b>Y</b>=Lyrics ‚Ä¢ <b>V</b>=Toggle take (v1/v2) ‚Ä¢ <b>S</b>=Toggle mode (Sample/Full)
            </div>
            <div class="ev-small" id="ev-lastSaved">Last saved: ‚Äî</div>
          </div>
        </article>

        <!-- BOOKLET CARD -->
        <aside class="ev-card ev-booklet" aria-label="Album booklet">
          <div class="ev-cardHead">
            <div>
              <div class="ev-cardTitle">Album Booklet</div>
              <div class="ev-cardHint">This page is designed to feel like a one-sheet insert.</div>
            </div>
            <button class="ev-btn ghost" id="ev-btn-print">Print</button>
          </div>

          <div class="ev-bookletBody" id="ev-bookletBody">
            <h3>Album concept</h3>
            <p>
              This isn't a year recap ‚Äî it's a systems log turned into music. The arc moves from sparks ‚Üí spine:
              from proving you can build to building like the outcome is inevitable.
              The sound stays unmistakably Swamp-Hop: halftime pressure, engineered minimalism, warm truth,
              and a tiny bit of neon circuitry.
            </p>

            <div class="ev-quote">
              <div class="ev-quoteKicker">Core mantra</div>
              <div class="ev-quoteText">"I build environments where good outcomes become the default."</div>
            </div>

            <h3>Tracklist + liner notes</h3>
            <div class="ev-bookletTrack" data-track="0">
              <b>A) Inevitable Spine</b>
              <p>The moment the builder becomes the architect. This is the thesis: no more flare-gun wins‚Äîjust durable outcomes.</p>
            </div>
            <div class="ev-bookletTrack" data-track="1">
              <b>B) Year in Signals</b>
              <p>A readable signal inside the static. Integration over accumulation, clarity over volume, finishing over novelty.</p>
            </div>
            <div class="ev-bookletTrack" data-track="2">
              <b>C) Quarter Reel (Stabilize ‚Üí Converge)</b>
              <p>Four-part montage: Q1 noise-cut, Q2 structural integrity, Q3 identity compression, Q4 convergence.</p>
            </div>
            <div class="ev-bookletTrack" data-track="3">
              <b>D) Guardrails (Double Down / Drop)</b>
              <p>Governance in chant form. If it doesn't connect or strengthen the system, it's optional.</p>
            </div>
            <div class="ev-bookletTrack" data-track="4">
              <b>I) Cadence / Seal (Future-Me Contract)</b>
              <p>The maintenance ritual: daily filter, weekly loop closure, monthly audit. The promise the system stays alive.</p>
            </div>

            <h3>Credits (in-world)</h3>
            <ul>
              <li><b>Founder Voice:</b> Timbr (wise grit)</li>
              <li><b>Signal / Tech Prophet:</b> Byte</li>
              <li><b>Spine:</b> NXCore</li>
              <li><b>Cockpit:</b> AeroCoreOS</li>
              <li><b>Heartbeat:</b> EchoVerse</li>
            </ul>

            <h3>How to listen</h3>
            <p>
              First run: A ‚Üí I in order. After that:
              discipline = D ‚Üí C ‚Üí I ‚Ä¢ meaning = A ‚Üí I ‚Ä¢ systems = B ‚Üí C ‚Üí D.
            </p>
          </div>
        </aside>
      </div>
    </section>
  </div>

  <script>
    // ---------- Background FX ----------
    (function spawnParticles(){
      const bg = document.getElementById('bgfx');
      const n = 46;
      for(let i=0;i<n;i++){
        const s = document.createElement('span');
        const left = Math.random()*100;
        const top = 100 + Math.random()*80;
        const dur = 10 + Math.random()*18;
        const delay = Math.random()*12;
        const size = 1 + Math.random()*2;
        s.style.left = left + 'vw';
        s.style.top = top + 'vh';
        s.style.width = size + 'px';
        s.style.height = size + 'px';
        s.style.animationDuration = dur + 's';
        s.style.animationDelay = (-delay) + 's';
        s.style.opacity = (0.25 + Math.random()*0.55).toFixed(2);
        bg.appendChild(s);
      }
    })();

    // ---------- P2: Shortcuts Overlay ----------
    const shortcutsModal = document.getElementById('shortcutsModal');
    const shortcutsClose = document.getElementById('shortcutsClose');
    
    function showShortcuts(){
      if(shortcutsModal && shortcutsClose){
        shortcutsModal.style.display = 'flex';
        setTimeout(()=> shortcutsClose.focus(), 100);
      }
    }
    function hideShortcuts(){
      if(shortcutsModal) shortcutsModal.style.display = 'none';
    }
    
    if(shortcutsClose) shortcutsClose.addEventListener('click', hideShortcuts);
    if(shortcutsModal){
      shortcutsModal.addEventListener('click', (e)=>{
        if(e.target === shortcutsModal) hideShortcuts();
      });
      
      // Focus trap in modal
      const modalContent = shortcutsModal.querySelector('.modal-content');
      if(modalContent){
        shortcutsModal.addEventListener('keydown', (e)=>{
          if(e.key === 'Escape') hideShortcuts();
          if(e.key === 'Tab'){
            const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
            const focusable = Array.from(modalContent.querySelectorAll(focusableElements));
            if(focusable.length === 0) return;
            const firstFocusable = focusable[0];
            const lastFocusable = focusable[focusable.length - 1];
            
            if(e.shiftKey && document.activeElement === firstFocusable){
              e.preventDefault();
              lastFocusable.focus();
            }else if(!e.shiftKey && document.activeElement === lastFocusable){
              e.preventDefault();
              firstFocusable.focus();
            }
          }
        });
      }
    }
    
    // Global keyboard handler for ? key
    window.addEventListener('keydown', (e)=>{
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
      if(tag === "input" || tag === "textarea") return;
      if(e.key === "?" || e.key === "/"){
        e.preventDefault();
        showShortcuts();
      }
    });

    // ---------- Tabs / Scenes ----------
    const tabs = [...document.querySelectorAll('.tab')];
    const scenes = [...document.querySelectorAll('.scene')];

    function showScene(id){
      // Batch DOM updates for better performance
      const isCapsule = id === 'sceneCapsule';
      scenes.forEach(s => s.classList.toggle('active', s.id === id));
      tabs.forEach(t => t.setAttribute('aria-selected', t.dataset.scene === id ? 'true' : 'false'));
      localStorage.setItem('echostory_scene_master', id);
      document.getElementById('modeLabel').textContent = isCapsule ? 'Ops / Capsule' : 'Story Mode';
    }

    tabs.forEach(t => t.addEventListener('click', () => showScene(t.dataset.scene)));
    document.querySelectorAll('[data-jump]').forEach(b => b.addEventListener('click', () => showScene(b.dataset.jump)));

    const savedScene = localStorage.getItem('echostory_scene_master');
    if(savedScene && document.getElementById(savedScene)) showScene(savedScene);

    // ---------- Audio ----------
    const ambience = document.getElementById('ambience');
    const audioStatus = document.getElementById('audioStatus');
    const btnToggleAudio = document.getElementById('btnToggleAudio');

    function setAudioStatus(on){
      audioStatus.textContent = 'Ambience: ' + (on ? 'On' : 'Off');
      btnToggleAudio.textContent = on ? 'Disable ambience' : 'Enable ambience';
    }

    btnToggleAudio.addEventListener('click', async ()=>{
      if(ambience.paused){
        try{ await ambience.play(); setAudioStatus(true); }
        catch(e){ setAudioStatus(false); showToast('err', 'No ambience loaded', 'Paste an audio URL in Operator Console, then Load.', 4000); }
      }else{
        ambience.pause(); setAudioStatus(false);
      }
    });

    document.getElementById('btnLoadAudio').addEventListener('click', async ()=>{
      const url = document.getElementById('audioUrl').value.trim();
      if(!url) return alert('Paste an audio URL first.');
      ambience.innerHTML = '';
      const src = document.createElement('source');
      src.src = url;
      src.type = url.endsWith('.wav') ? 'audio/wav' : 'audio/mpeg';
      ambience.appendChild(src);
      try{ ambience.load(); await ambience.play(); setAudioStatus(true); }
      catch(e){ setAudioStatus(false); showToast('err', 'Could not play URL', 'Make sure it is a direct link to an audio file (mp3/wav).', 4000); }
    });

    document.getElementById('btnStopAudio').addEventListener('click', ()=>{
      ambience.pause(); ambience.currentTime = 0; setAudioStatus(false);
    });

    // ---------- Mantra ----------
    const MANTRA_KEY = 'echostory_mantra_master_v1';
    const defaultMantra = "I build environments where good outcomes become the default.";
    const mantraPill = document.getElementById('mantraPill');
    const mantraInline = document.getElementById('mantraInline');
    const mantraInput = document.getElementById('mantraInput');

    function loadMantra(){
      const m = localStorage.getItem(MANTRA_KEY) || defaultMantra;
      mantraPill.textContent = m;
      mantraInline.textContent = m;
      mantraInput.value = m;
    }
    function saveMantra(m){
      localStorage.setItem(MANTRA_KEY, m);
      loadMantra();
    }
    document.getElementById('btnSetMantra').addEventListener('click', ()=>{
      const m = (mantraInput.value || "").trim() || defaultMantra;
      saveMantra(m);
    });
    document.getElementById('btnResetMantra').addEventListener('click', ()=> saveMantra(defaultMantra));
    loadMantra();

    // ---------- Capsule ----------
    const STORAGE_KEY = 'echostory_capsule_master_2026_v1';

    // NOTE: This checklist intentionally includes ‚Äúoutside-thread‚Äù additions:
    // NXCore/AeroCoreOS/EchoVerse milestones, automation (n8n), documentation/index rollups, brand pipeline.
    const defaultChecklist = [
      { id:'sig_integrate', group:'Year Signals', label:'Integrated systems instead of accumulating tools', done:false },
      { id:'sig_infra', group:'Year Signals', label:'Chose infrastructure over applause (durability over hype)', done:false },
      { id:'sig_sharp', group:'Year Signals', label:'Creative voice sharpened (clarity over loud)', done:false },
      { id:'sig_loops', group:'Year Signals', label:'Closed loops (finish over novelty)', done:false },
      { id:'sig_align', group:'Year Signals', label:'Stayed aligned (meaning stayed central)', done:false },

      { id:'q1_noise', group:'Quarter Reel', label:'Q1: Cleared noise; reclaimed roadmap authority', done:false },
      { id:'q2_struct', group:'Quarter Reel', label:'Q2: Built structural integrity; architect behavior', done:false },
      { id:'q3_comp', group:'Quarter Reel', label:'Q3: Identity compression; subtraction as creation', done:false },
      { id:'q4_conv', group:'Quarter Reel', label:'Q4: Convergence; tools support story + function', done:false },

      { id:'dd_integrate', group:'Guardrails', label:'Double down: Integration-first thinking', done:false },
      { id:'dd_narrative', group:'Guardrails', label:'Double down: Narrative-backed systems', done:false },
      { id:'dd_finish', group:'Guardrails', label:'Double down: Finishing energy (close loops weekly)', done:false },
      { id:'drop_rescue', group:'Guardrails', label:'Drop: Over-rescuing half-ideas', done:false },
      { id:'drop_explain', group:'Guardrails', label:'Drop: Explaining before shipping', done:false },
      { id:'drop_polish', group:'Guardrails', label:'Drop: Over-polishing before meaning', done:false },

      { id:'eco_divisions', group:'Ecosystem', label:'Division roles are clear and consistent across outputs', done:false },
      { id:'eco_localfirst', group:'Ecosystem', label:'Local-first posture is preserved (resilience as a design choice)', done:false },

      { id:'p1_nxcore', group:'2026 P1', label:'NXCore: stability + observability + backups + monitoring', done:false },
      { id:'p1_acos', group:'2026 P1', label:'AeroCoreOS: cockpit UX polish (one obvious way per action)', done:false },
      { id:'p1_echoverse_ui', group:'2026 P1', label:'EchoVerse: close UI gaps (media/art, queue, length, exports, work orders)', done:false },
      { id:'p1_n8n', group:'2026 P1', label:'n8n automation stack deployed + seeded workflows', done:false },
      { id:'p1_index', group:'2026 P1', label:'Master Index: Active Tasks / Decisions / Ideas rollups kept current', done:false },

      { id:'p2_visibility', group:'2026 P2', label:'Selective exposure: controlled presence + honest friction review', done:false },
      { id:'p2_reporting', group:'2026 P2', label:'Reporting maturity: dashboards + automated reporting habits', done:false },
      { id:'p2_brand', group:'2026 P2', label:'Brand pipeline: print-ready exports + listing metadata discipline', done:false },
      { id:'p2_collab', group:'2026 P2', label:'Light collaboration: plug-in ready, low risk, no rewrites for others', done:false },

      { id:'p3_money', group:'2026 P3', label:'Monetization experiments only if they don‚Äôt distort the system', done:false },
      { id:'p3_new', group:'2026 P3', label:'New projects only if infrastructure reuse and no new maintenance burden', done:false },
      { id:'p3_delight', group:'2026 P3', label:'Delight layer after function (polish later)', done:false },

      { id:'cad_daily', group:'Cadence', label:'Daily: apply filter + choose one meaningful action', done:false },
      { id:'cad_weekly', group:'Cadence', label:'Weekly: close one loop + honor one guardrail + improve one integration', done:false },
      { id:'cad_monthly', group:'Cadence', label:'Monthly: spine audit + priorities reset + visibility choice', done:false }
    ];

    function loadCapsule(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return { checklist: defaultChecklist, notes:'', savedAt:null, visibilityMode:'private', focusLane:'spine' };
      try{
        const parsed = JSON.parse(raw);
        const byId = new Map((parsed.checklist||[]).map(i => [i.id, i.done]));
        const merged = defaultChecklist.map(x => ({...x, done: !!byId.get(x.id)}));
        return {
          checklist: merged,
          notes: parsed.notes || '',
          savedAt: parsed.savedAt || null,
          visibilityMode: parsed.visibilityMode || 'private',
          focusLane: parsed.focusLane || 'spine'
        };
      }catch(e){
        return { checklist: defaultChecklist, notes:'', savedAt:null, visibilityMode:'private', focusLane:'spine' };
      }
    }

    function saveCapsule(state){
      const payload = {
        version: 'EV-CAPSULE-MASTER-2026-v1',
        capsuleId: 'EV-CAPSULE-2026',
        savedAt: new Date().toISOString(),
        mantra: localStorage.getItem(MANTRA_KEY) || defaultMantra,
        visibilityMode: state.visibilityMode,
        focusLane: state.focusLane,
        checklist: state.checklist.map(({id, done, group, label})=>({id, done, group, label})),
        notes: state.notes || ''
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      return payload;
    }

    const checklistEl = document.getElementById('checklist');
    const notesEl = document.getElementById('notes');
    const bar = document.getElementById('bar');
    const progressText = document.getElementById('progressText');
    const saveStamp = document.getElementById('saveStamp');
    const visibilityModeEl = document.getElementById('visibilityMode');
    const focusLaneEl = document.getElementById('focusLane');

    let state = loadCapsule();
    notesEl.value = state.notes;
    visibilityModeEl.value = state.visibilityMode;
    focusLaneEl.value = state.focusLane;

    function renderChecklist(){
      checklistEl.innerHTML = '';
      const groups = [...new Set(state.checklist.map(i=>i.group))];
      groups.forEach(g=>{
        const head = document.createElement('div');
        head.className = 'small';
        head.style.margin = '6px 0 2px';
        head.innerHTML = `<b>${g}</b>`;
        checklistEl.appendChild(head);

        state.checklist.filter(i=>i.group===g).forEach(item=>{
          const row = document.createElement('label');
          row.className = 'item';
          row.innerHTML = `
            <input type="checkbox" ${item.done ? 'checked':''} />
            <div class="lbl">${item.label}</div>
          `;
          const cb = row.querySelector('input');
          cb.addEventListener('change', ()=>{
            item.done = cb.checked;
            updateProgress();
            autosave();
          });
          checklistEl.appendChild(row);
        });
      });
      updateProgress(); updateStamp();
    }

    function updateProgress(){
      const total = state.checklist.length;
      const done = state.checklist.filter(i=>i.done).length;
      const pct = total ? Math.round((done/total)*100) : 0;
      bar.style.width = pct + '%';
      progressText.textContent = `${pct}% complete (${done}/${total})`;
    }

    function updateStamp(savedAt){
      const iso = savedAt || state.savedAt;
      saveStamp.textContent = 'Last saved: ' + (iso ? new Date(iso).toLocaleString() : '‚Äî');
    }

    function autosave(){
      state.notes = notesEl.value;
      state.visibilityMode = visibilityModeEl.value;
      state.focusLane = focusLaneEl.value;
      const payload = saveCapsule(state);
      state.savedAt = payload.savedAt;
      updateStamp(payload.savedAt);
    }

    notesEl.addEventListener('input', ()=>{
      if(window.__evNoteTimer) window.clearTimeout(window.__evNoteTimer);
      window.__evNoteTimer = window.setTimeout(()=> autosave(), 350);
    });
    visibilityModeEl.addEventListener('change', autosave);
    focusLaneEl.addEventListener('change', autosave);

    document.getElementById('btnSave').addEventListener('click', ()=> autosave());

    async function copyText(text){
      try{ await navigator.clipboard.writeText(text); return true; }
      catch(e){
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta);
        ta.select(); const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
      }
    }

    function payloadToMarkdown(payload){
      const lines = [];
      lines.push(`# EchoStory Capsule ‚Äî ${payload.capsuleId}`);
      lines.push(`- Saved: ${payload.savedAt}`);
      lines.push(`- Visibility: ${payload.visibilityMode}`);
      lines.push(`- Focus lane: ${payload.focusLane}`);
      lines.push(`- Mantra: ${payload.mantra}`);
      lines.push('');
      const groups = {};
      (payload.checklist||[]).forEach(i => {
        groups[i.group] = groups[i.group] || [];
        groups[i.group].push(i);
      });
      Object.keys(groups).forEach(g=>{
        lines.push(`## ${g}`);
        groups[g].forEach(i=>{
          lines.push(`- ${i.done ? '[x]' : '[ ]'} ${i.label}`);
        });
        lines.push('');
      });
      lines.push(`## Notes`);
      lines.push(payload.notes ? payload.notes : '_‚Äî_');
      lines.push('');
      return lines.join('\n');
    }

    function buildPayload(){
      state.notes = notesEl.value;
      state.visibilityMode = visibilityModeEl.value;
      state.focusLane = focusLaneEl.value;
      return saveCapsule(state);
    }

    function download(filename, content, type){
      const blob = new Blob([content], {type});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      if(url) setTimeout(()=>URL.revokeObjectURL(url), 500);
    }

    document.getElementById('btnCopyJson').addEventListener('click', async ()=>{
      const payload = buildPayload();
      const ok = await copyText(JSON.stringify(payload, null, 2));
      alert(ok ? 'Copied JSON.' : 'Copy failed.');
    });

    document.getElementById('btnCopyMd').addEventListener('click', async ()=>{
      const payload = buildPayload();
      const md = payloadToMarkdown(payload);
      const ok = await copyText(md);
      alert(ok ? 'Copied Markdown.' : 'Copy failed.');
    });

    document.getElementById('btnReset').addEventListener('click', ()=>{
      if(!confirm('Reset capsule progress + notes?')) return;
      localStorage.removeItem(STORAGE_KEY);
      state = loadCapsule();
      notesEl.value = state.notes;
      visibilityModeEl.value = state.visibilityMode;
      focusLaneEl.value = state.focusLane;
      renderChecklist();
    });

    document.getElementById('btnExportJson').addEventListener('click', ()=>{
      const payload = buildPayload();
      download('echostory_capsule_master_2026.json', JSON.stringify(payload, null, 2), 'application/json');
    });

    document.getElementById('btnExportMd').addEventListener('click', ()=>{
      const payload = buildPayload();
      const md = payloadToMarkdown(payload);
      download('echostory_capsule_master_2026.md', md, 'text/markdown');
    });

    document.getElementById('btnPrint').addEventListener('click', ()=> window.print());
    document.getElementById('btnSideExportJson').addEventListener('click', ()=> document.getElementById('btnExportJson').click());
    document.getElementById('btnSideExportMd').addEventListener('click', ()=> document.getElementById('btnExportMd').click());
    document.getElementById('btnSidePrint').addEventListener('click', ()=> window.print());

    // Render
    renderChecklist();

    // ---------- Capsule Metadata ----------
    const capsuleMeta = {
      type: "echostory",
      title: "Comprehensive Year Capsule (AeroVista/EchoVerse/NXCore)",
      capsuleId: "EV-CAPSULE-2026",
      createdLocal: new Date().toISOString(),
      contains: ["signals","quarters","guardrails","ecosystem","ledger","standards","philosophy","manifesto","map","cadence","capsule"],
      storageKey: STORAGE_KEY
    };
    document.getElementById('capsuleId').textContent = capsuleMeta.capsuleId;
    document.documentElement.dataset.echostoryCapsule = JSON.stringify(capsuleMeta);

    // ---------- MUSIC PLAYER ----------
    (function(){
      // ---------------------------
      // CONFIG
      // ---------------------------
      // If your MP3s are in a subfolder (e.g., "./audio/"), set:
      const basePath = "./audio/";

      // Use the "non-v2" files as canonical.
      // Order matches your EchoStory arc for the files you currently have.
      // Supports Sample (v1) and Full (v2) versions with toggle.
      const playlist = [
        {
          letter: "A",
          title: "Inevitable Spine",
          fileStd: "inevitable_spine.mp3",
          fileAlt: "inevitable_spine_(1).mp3",
          notes: "The moment the builder becomes the architect. No more flare-gun wins‚Äîjust durable outcomes.",
          tags: ["spine", "thesis", "durability", "coherence"],
          lyrics: `[VERSE 1]
From sparks to structure, we forged ahead
No more chasing flares in the night
The builder became architect instead
Building what lasts into the light

[CHORUS]
Inevitable spine, holding it all together
When the noise fades, what remains forever
Not the wins that flash, but the systems that endure
Coherence by default, that's the cure

[VERSE 2]
Proving turned to knowing, the shift was complete
No more questions if, only when and how deep
Infrastructure as love, systems that protect
Future selves can trust what we built and connect

[CHORUS]
Inevitable spine, holding it all together
When the noise fades, what remains forever
Not the wins that flash, but the systems that endure
Coherence by default, that's the cure`
        },
        {
          letter: "B",
          title: "Year in Signals",
          fileStd: "year_in_signals.mp3",
          fileAlt: "year_in_signals_(3).mp3",
          notes: "A readable signal inside the static: integration over accumulation, clarity over volume, finishing over novelty.",
          tags: ["signals", "integration", "clarity", "finish"],
          lyrics: `[INTRO - SIGNAL TONE]
...beep... transmission received...

[VERSE 1]
In the static of the year, we found the signal clear
Integration over piles, clarity over noise
Finishing the loops we started, closing every door
Not chasing shiny objects, building what endures

[CHORUS]
Year in signals, reading between the lines
Coherence emerged from scattered designs
Not volume, not hype, but the quiet strength
Of systems that connect and go to any length

[VERSE 2]
From accumulation to connection, the pivot was made
Each piece finding purpose, no longer waylaid
Stories with function, tools that carry meaning
The signal got stronger, the vision more gleaming

[BRIDGE]
Reduce friction, deepen meaning, strengthen the system
Daily filter applied, no more random additions
Finishing energy preserved, coherence achieved
The signal is clear now, the message received

[OUTRO]
...transmission complete...`
        },
        {
          letter: "C",
          title: "Quarter Reel (Stabilize ‚Üí Converge)",
          fileStd: "quarter_reel_(stabilize_to_converge).mp3",
          fileAlt: "quarter_reel_(stabilize_to_converge)_(1).mp3",
          notes: "Four-part montage: Q1 noise-cut, Q2 structural integrity, Q3 identity compression, Q4 convergence.",
          tags: ["quarters", "arc", "structure", "converge"],
          lyrics: `[Q1 - STABILIZE]
Quarter one, clearing the noise
Roadmap authority returned, made the hard choice
Activity wasn't progress, we saw through the veil
Stabilize the foundation, let the real work prevail

[Q2 - STRUCTURE]
Quarter two, integrity built
Architect behavior emerged, decisions that held
From builder to system steward, the evolution complete
Structural bones formed, ready for anything we'd meet

[Q3 - COMPRESS]
Quarter three, identity squeezed
Subtraction became creation, what we kept was what we believed
Output intentional, systems refined
Compression revealed the essence we designed

[Q4 - CONVERGE]
Quarter four, everything aligned
One center orbiting, story and narrative combined
Tools supported the narrative, narrative drove the tools
Convergence achieved, breaking all the old rules

[FINAL CHORUS]
Stabilize to structure, compress to converge
The arc of the year, each quarter we emerged
From scattered to focused, from loose to tight
Coherence by default, burning bright`
        },
        {
          letter: "D",
          title: "Guardrails (Double Down / Drop)",
          fileStd: "guardrails_(double_down_drop).mp3",
          fileAlt: "guardrails_(double_down_drop)_(1).mp3",
          notes: "Governance in chant form. If it doesn't connect or strengthen the system, it's optional.",
          tags: ["guardrails", "discipline", "drop", "keep"],
          lyrics: `[CHANT INTRO]
Guardrails rising, discipline calling
What serves the system? What deserves falling?

[VERSE 1 - DOUBLE DOWN]
Integration first, connections that matter
Narrative systems, stories that function
Finishing energy, loops we complete
Internal coherence, what makes it all sweet

[CHORUS]
Guardrails guide us, double down or drop
If it doesn't reduce friction, if it doesn't make it stop
Deepen meaning, strengthen system - that's the test
Everything else is optional, put it to rest

[VERSE 2 - DROP]
Over-rescuing ideas that already taught the lesson
Explaining before shipping, presence over confession
Over-polishing confusion, clarity comes first
Re-litigating decisions, trust what we rehearsed

[BRIDGE]
The daily filter: reduce friction, deepen meaning, strengthen system
Applied relentlessly, no more random additions
Guardrails protect the coherence, protect the flow
What doesn't serve the system? It's time to let go

[FINAL CHANT]
Guardrails standing, the system protected
Coherence preserved, nothing neglected
Double down on what works, drop what divides
Guardrails guide the way to the other side`
        },
        {
          letter: "E",
          title: "Ecosystem Anthem (Orbit)",
          fileStd: "ecosystem_anthem_(orbit).mp3",
          fileAlt: "ecosystem_anthem_(orbit)_(1).mp3",
          notes: "The ecosystem in motion: divisions, systems, and the orbit of coherence around a central narrative.",
          tags: ["ecosystem", "orbit", "divisions", "systems"],
          lyrics: `[VERSE 1]
The ecosystem orbits, divisions aligned
Nexus TechWorks, SkyForge, EchoVerse combined
Summit Learning, Lumina, Vespera, Horizon
Each division a planet, each system a reason

[CHORUS]
Ecosystem anthem, orbit around the core
Story plus infrastructure, repeatability we adore
Not vibes, not chaos, a system that holds
Each division connected, the narrative unfolds

[VERSE 2]
NXCore the spine, AeroCoreOS the cockpit
EchoVerse the signal, the heartbeat we've got
Each piece in orbit, each system connects
The ecosystem thrives, nothing rejects

[BRIDGE]
Orbit around coherence, the center holds strong
Each division contributes, nothing goes wrong
The ecosystem anthem, the orbit we sing
Coherence by default, what the future will bring`
        },
        {
          letter: "F",
          title: "Milestone Ledger",
          fileStd: "milestone_ledger.mp3",
          fileAlt: "milestone_ledger_(1).mp3",
          notes: "The real work wins: milestones that matter, not the flash but the foundation built.",
          tags: ["milestones", "ledger", "wins", "foundation"],
          lyrics: `[VERSE 1]
The milestone ledger, the real work recorded
Not the flashy wins, but the foundation hoarded
NXCore became authoritative, storage and services
Local-first posture, the system preserves us

[CHORUS]
Milestone ledger, the real work wins
Foundation built, where true strength begins
Not the hype, not the noise, but what endures
The milestone ledger, the system secures

[VERSE 2]
Each milestone marked, each win that matters
Infrastructure built, the system that scatters
Chaos to order, noise to signal
The milestone ledger, the progress we'll signal

[BRIDGE]
Real work recorded, foundation laid
Milestone ledger, the progress we've made
Each entry matters, each win that counts
The milestone ledger, the system amounts`
        },
        {
          letter: "G",
          title: "Standards (Ethics Over Noise)",
          fileStd: "standards_(ethics_over_noise).mp3",
          fileAlt: "standards_(ethics_over_noise)_(1).mp3",
          notes: "The moral and operational spine: policies consistent, escalations defined, clarity over ambiguity.",
          tags: ["standards", "ethics", "policies", "clarity"],
          lyrics: `[VERSE 1]
Standards defined, ethics over noise
Policies consistent, the system has poise
Escalations follow defined paths
Training measurable, clarity that lasts

[CHORUS]
Standards standing, ethics over noise
Durable systems, ethical posture, repeatable choice
Clarity beats ambiguity, truth over lies
Standards guide us, the system applies

[VERSE 2]
The moral spine, operational truth
Standards protect us, from chaos to proof
Ethics first, then efficiency
Standards guide us, the system we see

[BRIDGE]
Durable systems, ethical posture, repeatable truth
Standards protect us, from chaos to proof
Ethics over noise, clarity over confusion
Standards guide us, the system's conclusion`
        },
        {
          letter: "H",
          title: "2026 Map (P1 P2 P3)",
          fileStd: "2026_map_(p1_p2_p3).mp3",
          fileAlt: "2026_map_(p1_p2_p3)_(1).mp3",
          notes: "The roadmap forward: Phase 1 foundation, Phase 2 expansion, Phase 3 integration. The map to coherence.",
          tags: ["2026", "map", "roadmap", "phases"],
          lyrics: `[VERSE 1]
2026 map laid out, phases defined
P1 foundation, P2 expansion aligned
P3 integration, the roadmap we see
The map to coherence, the path to be free

[CHORUS]
2026 map, P1 P2 P3
The roadmap forward, the path we see
Foundation first, then expansion
Integration follows, the system's passion

[VERSE 2]
Phase one builds the foundation strong
Phase two expands, the system belongs
Phase three integrates, everything connects
The 2026 map, the system protects

[BRIDGE]
The map is clear, the phases defined
2026 ahead, the system designed
P1 P2 P3, the roadmap we follow
The map to coherence, no time to wallow`
        },
        {
          letter: "I",
          title: "Cadence / Seal (Future-Me Contract)",
          fileStd: "cadence_seal_(future-me_contract).mp3",
          fileAlt: "cadence_seal_(future-me_contract)_(1).mp3",
          notes: "The maintenance ritual: daily filter, weekly loop closure, monthly audit. The promise the system stays alive.",
          tags: ["cadence", "seal", "maintenance", "future-me"],
          lyrics: `[OPENING SEAL]
Future me, this contract we sign
The system stays alive, the cadence divine
Daily, weekly, monthly - the rhythm we keep
Promise to future selves what we won't let sleep

[VERSE 1 - DAILY]
Daily filter applied, three questions we ask
Reduce friction, deepen meaning, strengthen the task
One meaningful action, choose with care
Seal one sentence future you can trust is there

[CHORUS]
Cadence seals the deal, future me contract
Maintenance ritual, that's a solid pact
Protect finishing energy, protect coherence, protect meaning
The system stays alive, no more daydreaming

[VERSE 2 - WEEKLY]
Weekly we close loops, honor guardrails we set
Delete what's optional, improve integrations yet
One loop closed, one guardrail honored, one integration improved
The system gets stronger, the foundation unmoved

[VERSE 3 - MONTHLY]
Monthly we audit, spine checked for fractures
Priorities reset, visibility choices we capture
What becomes public? What stays internal?
The contract with future me, eternally eternal

[BRIDGE]
Future me reads this, sees the system intact
Not abandoned to chaos, not left to the rack
The cadence preserved it, the seal kept it tight
Coherence by default, burning through the night

[FINAL SEAL]
Future me, the contract is sealed
The system you inherit is real and revealed
Cadence maintained it, seal protected it
Coherence by default - we committed to it`
        }
      ];

      // ---------------------------
      // STATE (localStorage)
      // ---------------------------
      const LS_KEY = "ev_coherence_player_v1";
      const audio = document.getElementById("ev-audio");

      const el = {
        list: document.getElementById("ev-list"),
        letter: document.getElementById("ev-letter"),
        name: document.getElementById("ev-trackName"),
        file: document.getElementById("ev-trackFile"),
        time: document.getElementById("ev-trackTime"),
        cur: document.getElementById("ev-cur"),
        dur: document.getElementById("ev-dur"),
        seek: document.getElementById("ev-seek"),
        vol: document.getElementById("ev-vol"),
        play: document.getElementById("ev-play"),
        prev: document.getElementById("ev-prev"),
        next: document.getElementById("ev-next"),
        loop: document.getElementById("ev-loop"),
        lyrics: document.getElementById("ev-lyrics"),
        notes: document.getElementById("ev-notesBody"),
        tags: document.getElementById("ev-tags"),
        lyricsPanel: document.getElementById("ev-lyrics-panel"),
        lyricsContent: document.getElementById("ev-lyrics-content"),
        lastSaved: document.getElementById("ev-lastSaved"),
        btnPrint: document.getElementById("ev-btn-print"),
        btnCopy: document.getElementById("ev-btn-copy"),
        btnBooklet: document.getElementById("ev-btn-booklet"),
        saveBadge: document.getElementById("ev-saveBadge"),
        bookletBody: document.getElementById("ev-bookletBody"),
        versionBadge: document.getElementById("ev-versionBadge"),
        vStd: document.getElementById("ev-vStd"),
        vAlt: document.getElementById("ev-vAlt"),
        sHuman: document.getElementById("ev-sHuman"),
        sAI: document.getElementById("ev-sAI")
      };

      function fmt(sec){
        if(!isFinite(sec)) return "0:00";
        sec = Math.max(0, Math.floor(sec));
        const m = Math.floor(sec/60);
        const s = (sec%60).toString().padStart(2,"0");
        return `${m}:${s}`;
      }

      function loadState(){
        try{
          const raw = localStorage.getItem(LS_KEY);
          if(!raw) return { idx:0, t:0, vol:0.9, loop:false, lyrics:false, version:"std", source:"human" };
          const st = JSON.parse(raw);
          return {
            idx: Number.isInteger(st.idx) ? Math.max(0, Math.min(playlist.length-1, st.idx)) : 0,
            t: typeof st.t === "number" ? Math.max(0, st.t) : 0,
            vol: typeof st.vol === "number" ? Math.max(0, Math.min(1, st.vol)) : 0.9,
            loop: !!st.loop,
            lyrics: !!st.lyrics,
            version: (st.version === "alt") ? "alt" : "std",
            source: (st.source === "ai") ? "ai" : "human"
          };
        }catch(e){
          return { idx:0, t:0, vol:0.9, loop:false, lyrics:false, version:"std", source:"human" };
        }
      }

      function saveState(st){
        const payload = {
          idx: st.idx,
          t: st.t,
          vol: st.vol,
          loop: st.loop,
          lyrics: st.lyrics,
          version: st.version,
          source: st.source,
          savedAt: new Date().toISOString()
        };
        localStorage.setItem(LS_KEY, JSON.stringify(payload));
        el.lastSaved.textContent = "Last saved: " + new Date(payload.savedAt).toLocaleString();
        el.saveBadge.textContent = "Autosave: On";
      }

      let state = loadState();

      // ---------------------------
      // UI Render
      // ---------------------------
      function renderList(){
        const fragment = document.createDocumentFragment();
        playlist.forEach((t, i) => {
          const row = document.createElement("div");
          row.className = "ev-row" + (i===state.idx ? " active" : "");
          row.tabIndex = 0;

          const meta = t.fileAlt
            ? `${t.fileStd}  ‚Ä¢  v2: ${t.fileAlt}`
            : `${t.fileStd}  ‚Ä¢  v2: ‚Äî`;

          row.innerHTML = `
            <div class="ev-rowLeft">
              <span class="ev-chip">${t.letter}</span>
              <div style="min-width:0">
                <div class="ev-rowTitle">${t.title}</div>
                <div class="ev-rowMeta">${meta}</div>
              </div>
            </div>
            <div class="ev-rowRight">
              <span class="ev-small">Tap</span>
            </div>
          `;

          // Use event delegation instead of individual listeners for better performance
          row.addEventListener("click", (e)=>{
            if(e.target.closest('.ev-row')) selectTrack(i, true);
          });
          row.addEventListener("keydown", (e)=>{
            if((e.key === "Enter" || e.key === " ") && e.target.closest('.ev-row')){
              e.preventDefault();
              selectTrack(i, true);
            }
          });

          fragment.appendChild(row);
        });

        el.list.innerHTML = "";
        el.list.appendChild(fragment);
      }

      function renderNow(){
        const t = playlist[state.idx];
        el.letter.textContent = t.letter;
        el.name.textContent = t.title;
        el.file.textContent = trackFile(t);

        el.notes.textContent = t.notes;
        el.tags.innerHTML = "";
        t.tags.forEach(tag=>{
          const s = document.createElement("span");
          s.className = "ev-tag";
          s.textContent = tag;
          el.tags.appendChild(s);
        });

        // Show/hide lyrics panel
        if(state.lyrics && t.lyrics){
          el.lyricsPanel.style.display = "block";
          el.lyricsContent.textContent = t.lyrics;
        }else{
          el.lyricsPanel.style.display = "none";
        }

        // Booklet track click ‚Üí play track
        document.querySelectorAll(".ev-bookletTrack").forEach(node=>{
          node.style.borderColor = "rgba(255,255,255,.10)";
        });
        const bookletActive = document.querySelector(`.ev-bookletTrack[data-track="${state.idx}"]`);
        if(bookletActive) bookletActive.style.borderColor = "rgba(39,224,255,.45)";

        // highlight playlist
        document.querySelectorAll(".ev-row").forEach((node, i)=>{
          node.classList.toggle("active", i === state.idx);
        });
      }

      function trackFile(track){
        const wantAlt = (state.version === "alt");
        const pick = wantAlt ? (track.fileAlt || track.fileStd) : track.fileStd;
        return pick || track.fileStd;
      }

      function setVersionUI(){
        const t = playlist[state.idx];
        const altExists = !!t.fileAlt;

        // Take buttons
        el.vStd.setAttribute("aria-pressed", state.version === "std");
        el.vAlt.setAttribute("aria-pressed", state.version === "alt");

        // Mode buttons
        if(el.sHuman) el.sHuman.setAttribute("aria-pressed", state.source !== "ai");
        if(el.sAI) el.sAI.setAttribute("aria-pressed", state.source === "ai");

        // Badge
        const modeLabel = (state.source === "ai") ? "Full" : "Sample";
        const takeLabel = (state.version === "alt") ? "v2" : "v1";
        el.versionBadge.textContent = `Mode: ${modeLabel} ‚Ä¢ Take: ${takeLabel}`;

        // Disable v2 if missing
        el.vAlt.disabled = !altExists;
        el.vAlt.title = altExists ? "Switch to v2" : "No v2 file for this track";
      }

      function setLoop(on){
        state.loop = !!on;
        audio.loop = state.loop;
        const loopText = el.loop.querySelector('.ev-loop-text');
        const loopIcon = el.loop.querySelector('.ev-icon-loop');
        if(loopText) loopText.textContent = "Loop: " + (state.loop ? "On" : "Off");
        if(loopIcon) loopIcon.style.opacity = state.loop ? "1" : "0.5";
        if(!loopText) el.loop.textContent = "Loop: " + (state.loop ? "On" : "Off");
        saveState({ ...state, t: audio.currentTime || state.t, vol: audio.volume, version: state.version, source: state.source });
      }

      function setPlayButton(){
        const playIcon = el.play.querySelector('.ev-icon-play');
        const pauseIcon = el.play.querySelector('.ev-icon-pause');
        if(playIcon && pauseIcon){
          if(audio.paused){
            playIcon.style.display = 'block';
            pauseIcon.style.display = 'none';
          }else{
            playIcon.style.display = 'none';
            pauseIcon.style.display = 'block';
          }
        }else{
          // Fallback to text if icons not found
          el.play.textContent = audio.paused ? "‚ñ∂" : "‚è∏";
        }
      }

      function setAudioSrc(){
        const t = playlist[state.idx];
        let file = (state.version === "alt" && t.fileAlt) ? t.fileAlt : t.fileStd;

        // Full mode adds track letter prefix (a, b, c, d, e, f, g, h, i) to whichever take is selected
        if(state.source === "ai"){
          const letter = t.letter.toLowerCase();
          // For v2 files, replace _([number]) with ([number]) to match Full mode naming
          file = file.replace(/_(\(\d+\))/g, '$1');
          file = letter + "_" + file;
        }

        // Update audio src (GitHub Pages may not handle encoded URLs properly)
        audio.src = basePath + file;
        el.file.textContent = file;
      }

      function selectTrack(idx, autoplay){
        state.idx = idx;
        state.t = 0;
        setAudioSrc();
        renderNow();
        renderList();
        setVersionUI();
        saveState({ ...state, t: 0, vol: audio.volume, loop: state.loop, lyrics: state.lyrics, version: state.version, source: state.source });

        if(autoplay){
          audio.play().catch(()=>{ /* ignore autoplay restrictions */ });
        }
        setPlayButton();
      }

      async function switchVersion(to){
        const t = playlist[state.idx];
        if(to === "alt" && !t.fileAlt) return;

        const wasPlaying = !audio.paused;
        const pos = audio.currentTime || 0;

        state.version = (to === "alt") ? "alt" : "std";
        setVersionUI();
        setAudioSrc();
        saveState({ ...state, t: pos, vol: audio.volume, loop: state.loop, lyrics: state.lyrics, version: state.version, source: state.source });

        const onMeta = async ()=>{
          audio.removeEventListener("loadedmetadata", onMeta);
          if(isFinite(audio.duration) && pos < audio.duration - 0.25) audio.currentTime = pos;
          if(wasPlaying) { try{ await audio.play(); }catch(e){} }
          setPlayButton();
        };
        audio.addEventListener("loadedmetadata", onMeta);
      }

      async function setSource(mode){
        const wasPlaying = !audio.paused;
        const pos = audio.currentTime || 0;

        state.source = (mode === "ai") ? "ai" : "human";
        setVersionUI();
        setAudioSrc();
        saveState({ ...state, t: pos, vol: audio.volume, loop: state.loop, lyrics: state.lyrics, version: state.version, source: state.source });

        const onMeta = async ()=>{
          audio.removeEventListener("loadedmetadata", onMeta);
          if(isFinite(audio.duration) && pos < audio.duration - 0.25) audio.currentTime = pos;
          if(wasPlaying) { try{ await audio.play(); }catch(e){} }
          setPlayButton();
        };
        audio.addEventListener("loadedmetadata", onMeta);
      }

      // ---------------------------
      // Progress + Seek
      // ---------------------------
      let seeking = false;

      audio.addEventListener("loadedmetadata", ()=>{
        // restore time only if same track load during init
        if(state.t > 0 && state.t < audio.duration - 0.25){
          audio.currentTime = state.t;
        }
        el.dur.textContent = fmt(audio.duration);
        el.seek.value = "0";
        setPlayButton();
      });

        audio.addEventListener("timeupdate", ()=>{
          if(!seeking){
            const dur = audio.duration || 0;
            const cur = audio.currentTime || 0;
            const v = dur ? Math.round((cur/dur)*1000) : 0;
            el.seek.value = String(v);
          }

          // Cache time formatting to avoid repeated calculations
          const currentTime = audio.currentTime || 0;
          const duration = audio.duration || 0;
          el.cur.textContent = fmt(currentTime);
          el.dur.textContent = fmt(duration);
          el.time.textContent = `${fmt(currentTime)} / ${fmt(duration)}`;

          // autosave throttle - only save if playing and time has changed significantly
          if(currentTime > 0 && !audio.paused){
            if(!window.__evSaveTick || Date.now() - window.__evSaveTick > 2500){
              window.__evSaveTick = Date.now();
              saveState({ ...state, t: currentTime, vol: audio.volume, loop: state.loop, lyrics: state.lyrics, version: state.version, source: state.source });
            }
          }
        });

      audio.addEventListener("ended", ()=>{
        // If loop is off, advance
        if(!state.loop){
          next(true);
        }
      });

      audio.addEventListener("error", (e)=>{
        console.error('Audio load error:', e.target.error, 'File:', audio.src);
        showToast('err', 'Audio failed to load', 'Check file or try different take', 4000);
      });

      el.seek.addEventListener("input", ()=>{
        seeking = true;
      });
      el.seek.addEventListener("change", ()=>{
        const dur = audio.duration || 0;
        const v = Number(el.seek.value) / 1000;
        const target = dur * v;
        audio.currentTime = isFinite(target) ? target : 0;
        seeking = false;
        saveState({ ...state, t: audio.currentTime || 0, vol: audio.volume, loop: state.loop, lyrics: state.lyrics, version: state.version, source: state.source });
      });

      // ---------------------------
      // Controls
      // ---------------------------
      function prev(autoplay){
        const i = (state.idx - 1 + playlist.length) % playlist.length;
        selectTrack(i, autoplay);
      }
      function next(autoplay){
        const i = (state.idx + 1) % playlist.length;
        selectTrack(i, autoplay);
      }

      el.play.addEventListener("click", ()=>{
        if(audio.paused){
          audio.play().catch(()=>{ /* ignore autoplay restrictions */ });
        }else{
          audio.pause();
        }
        setPlayButton();
      });

      el.prev.addEventListener("click", ()=> prev(true));
      el.next.addEventListener("click", ()=> next(true));

      // Cache volume value to avoid unnecessary conversions and saves
      let lastVolume = audio.volume;
      el.vol.addEventListener("input", ()=>{
        const newVol = Number(el.vol.value);
        if(Math.abs(newVol - lastVolume) > 0.01){ // Only save if changed significantly
          lastVolume = newVol;
          audio.volume = newVol;
          saveState({ ...state, t: audio.currentTime || 0, vol: newVol, loop: state.loop, lyrics: state.lyrics, version: state.version, source: state.source });
        }
      });

      el.loop.addEventListener("click", ()=> setLoop(!state.loop));

      el.lyrics.addEventListener("click", ()=>{
        state.lyrics = !state.lyrics;
        el.lyrics.textContent = state.lyrics ? "Hide Lyrics" : "Lyrics";
        renderNow();
        saveState({ ...state, t: audio.currentTime || 0, vol: audio.volume, loop: state.loop, lyrics: state.lyrics, version: state.version, source: state.source });
      });

      el.vStd.addEventListener("click", ()=> switchVersion("std"));
      el.vAlt.addEventListener("click", ()=> switchVersion("alt"));

      if(el.sHuman) el.sHuman.addEventListener("click", ()=> setSource("human"));
      if(el.sAI) el.sAI.addEventListener("click", ()=> setSource("ai"));

      // Booklet interactions
      document.querySelectorAll(".ev-bookletTrack").forEach(node=>{
        node.addEventListener("click", ()=>{
          const idx = Number(node.getAttribute("data-track"));
          if(Number.isFinite(idx)) selectTrack(idx, true);
        });
      });

      el.btnPrint.addEventListener("click", ()=> window.print());

      el.btnCopy.addEventListener("click", async ()=>{
        const lines = playlist.map(t => {
          const alt = t.fileAlt ? t.fileAlt : "‚Äî";
          const letter = t.letter.toLowerCase();
          const fullV1 = letter + ")" + t.fileStd;
          const fullV2 = alt === "‚Äî" ? "‚Äî" : letter + "_" + alt.replace(/_(\(\d+\))/g, '$1');
          return `${t.letter}) ${t.title}\n   v1: ${t.fileStd}\n   v2:  ${alt}\n   Full v1: ${fullV1}\n   Full v2:  ${fullV2}`;
        });
        const txt = `EchoStory ‚Äî COHERENCE BY DEFAULT\n\n` + lines.join("\n\n");
        try{
          await navigator.clipboard.writeText(txt);
          el.btnCopy.textContent = "Copied";
          setTimeout(()=> el.btnCopy.textContent = "Copy Tracklist", 900);
        }catch(e){
          alert(txt);
        }
      });

      // Toggle booklet scroll focus (mobile convenience)
      el.btnBooklet.addEventListener("click", ()=>{
        el.bookletBody.scrollIntoView({behavior:"smooth", block:"start"});
      });

      // Keyboard shortcuts
      window.addEventListener("keydown", (e)=>{
        // ignore typing into inputs
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
        if(tag === "input" || tag === "textarea") return;

        if(e.key === " "){ e.preventDefault(); el.play.click(); }
        if(e.key === "n" || e.key === "N"){ next(true); }
        if(e.key === "p" || e.key === "P"){ prev(true); }
        if(e.key === "l" || e.key === "L"){ setLoop(!state.loop); }
        if(e.key === "y" || e.key === "Y"){
          state.lyrics = !state.lyrics;
          el.lyrics.textContent = state.lyrics ? "Hide Lyrics" : "Lyrics";
          renderNow();
          saveState({ ...state, t: audio.currentTime || 0, vol: audio.volume, loop: state.loop, lyrics: state.lyrics, version: state.version, source: state.source });
        }
        if(e.key === "v" || e.key === "V"){
          const t = playlist[state.idx];
          if(!t.fileAlt) return;
          switchVersion(state.version === "std" ? "alt" : "std");
        }
        if(e.key === "s" || e.key === "S"){
          setSource(state.source === "ai" ? "human" : "ai");
        }
        if(e.key === "ArrowRight"){ audio.currentTime = Math.min((audio.currentTime||0)+5, audio.duration||1e9); }
        if(e.key === "ArrowLeft"){ audio.currentTime = Math.max((audio.currentTime||0)-5, 0); }
        if(e.key === "?" || e.key === "/"){
          e.preventDefault();
          showShortcuts();
        }
      });

      // ---------------------------
      // INIT
      // ---------------------------
      audio.volume = state.vol;
      el.vol.value = String(state.vol);
      setLoop(state.loop);
      el.lyrics.textContent = state.lyrics ? "Hide Lyrics" : "Lyrics";
      setVersionUI();

      renderList();
      setAudioSrc();
      renderNow();

        // Show saved time badge if exists
        try{
          const raw = localStorage.getItem(LS_KEY);
          if(raw){
            const parsed = JSON.parse(raw);
            if(parsed.savedAt){
              el.lastSaved.textContent = "Last saved: " + new Date(parsed.savedAt).toLocaleString();
            }
          }
        }catch(e){
          console.warn('Failed to load saved state:', e);
        }

      // Attempt to restore last position
      audio.addEventListener("canplay", ()=>{
        // only do once
        if(window.__evRestored) return;
        window.__evRestored = true;
        if(state.t > 0 && isFinite(audio.duration) && state.t < audio.duration - 0.25){
          audio.currentTime = state.t;
        }
        setPlayButton();
      });

      // If the saved idx is not 0, ensure list highlights it
      if(state.idx !== 0){
        renderList();
        renderNow();
      }

    })();
  </script>
  
  <!-- PWA Service Worker Registration -->
  <script src="./pwa.js"></script>
</body>
</html>
